<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link rel="icon" href="card_images/favicon.png?" type="image/x-icon">
    <title>The Birdhouse</title>
</head>
<body>
    
    <button id="showHamburgerButton" class="show-hamburger-button">
        <img src="card_images/favicon.png" alt="">
    </button>

    <div id="hamburgerMenu" class="hamburger-menu">
        <!-- <button id="hamburgerButton" class="hamburger-button">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button> -->
        <div id="menuContent" class="menu-content">
          <!-- Your menu items go here -->
          <br><br><br><br><br><br><br><br><br>
          <button id="addCardMenuButton">Add a card</button>
          <!-- <button id="viewButton">Save (broken)</button> -->
          <!-- <button id="updateButton">Update (broken)</button> -->
          <!-- <input type="file" accept="text/*" id="updateInputTextId"> -->
          <br><br>
          <button id="displayDecksButtonId">Decks</button>
          <br><br>
          <!-- <button id="printScreenButtonId">Print</button> -->
          <br><br>
          <!-- <button id="battleMenuButtonId">Battleground</button> -->
          <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
          <button id="accountButton">Account</button>
        </div>
    </div>


    <div class="header-container" id="headerContainerId">
       
            <div class="header-icon-title">
                <div class="icon-and-title">
                    <!-- <img id="iconTopPage" src="card_images/favicon.png" width="50px" height="50px" alt=""> -->
                    <!-- <h1>The Birdhouse</h1> -->
                </div>
                <div class="nav-button-container">
                    <button id="displayScrollWrapperId">HOME</button>
                    <button id="displayScrollWrapperRandomId">RANDOM</button>
                    <button id="displayNotesId">NOTES</button>
                    <button id="addCardNavButton">ADD</button>
                    <!-- <button id="displayDecksButtonId">DECKS</button> -->
                </div>
                
                <div class="user-id-container" id = userIdContainer></div>
                <!-- <img id="testingCardQueueId"src="" alt="Test"> -->
            </div>
       
       
            
        
    </div>
    

    <!-- SEARCH CONTAINER -->
    <div class="search-bar-container" id="searchBarContainer">
        <div id="toggleSearchButton" class="toggle-search-button">
            <img src="card_images/searchIcon.png" id="searchIconId" alt="">
        </div>
        <div id="searchFormsContainer" class="search-forms-container">
            
        <div class="search-input-container">
            <input type="text" placeholder="Title" id="titleSearchPrompt">
            
            <input type="text" placeholder="Type" id="typeSearchPrompt">
            
            <input type="text" placeholder="Tag" id="tagSearchPrompt">
        </div>
            <button type="submit" id="searchCardsButton">SEARCH</button>
        </div>
    </div>



    <!-- SCROLLING IMAGES FROM CARDS HERE -->
    <div class="lower-content-container" id = "lowerContentId">
        
       


            <div class="scroll-wrapper" id = "scrollWrapperId">
         
          
          
          <!-- Add more image elements as needed -->
            </div>
        
    </div>
    <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>



    



    <!-- THIS IS THE CARD PREVIEW OVERLAY
    
    To DO: Change the left-column to something totally new (breaks the addCArd overlay as left-column)
    Change the cardNameTitleTextId to something new, breaks the addCard image display
    Change the imagePreview to something new, breaks the addCard image display
    -->

    <div id="viewCardOverlayId" class="overlay">
        <div class="overlay-content" id="viewOverlayContainerId">
            <div class="content-container" id="contentContainerId">
                <div class="left-column" id="previewLeftColumn">
                    <div class = "view-card-inner-left-column" id="viewCardInnerLeftColumn">
                        <div class="new-image-container">
                            <img id = "newImagePreview" src="" alt="Card"/>
                        <!-- <div class="text-box-card-name">
                            <h2 id="newCardNameTitleTextId">Card Title</h2>
                        </div>
                        <div class="text-box-card-rules">
                            <p id="newCardRulesTextId">Card Rules</p> 
                        </div> -->
                        </div>
                    </div>
                </div>
                <div class="right-column" id="previewRightColumn">
                    <div class="dropdown">
                        <select id="editSelect">
                        <option value="view">View</option>
                        <option value="edit">Edit</option>
                        <option value="delete">Delete</option>
                        </select>
                    </div>
                    <div class="innerRightColumn" id="innerRightColumnId">

                        
                        

                        <h2>View Card</h2>
                        <div id="cardInformation">
                            <!-- Add fields for the cards to be populated here-->
                        </div>

                        <p id="overlayTypeTest">Type</p>

                        <p id="overlayCardTitleP">Type</p>

                        <button id="addPreviewButton">Add to Preview</button>

                        
                    </div>
                </div>

            </div>
        </div>
    </div>










    <!-- THIS IS THE 'ADD A CARD' OVERLAY -->

    <div id="addCardOverlay" class="overlay">
        <div class="overlay-content" id="addOverlayContainerId">
          <div class="content-container" id="contentContainerId">
            <div class="left-column" id="leftColumn">
                <div class="add-card-inner-left-column" id="addCardInnerLeftColumn">
                    <div class="dropdown-container">
                        <h2>Add</h2>
                        <select class="add-dropdown-select" id="cardTypeSelect">
                          <option value="bird">Bird</option>
                          <option value="song">Song</option>
                          <option value="feather">Feather</option>
                          <option value="egg">Egg</option>
                        </select>
                        <h2>Card</h2>
                    </div>
                    <!-- <h2>Add Bird Card</h2> -->
                    <form action="" id="inputForm">
                        <label for="cardNameId">Card Name:</label>
                        <input type="text" placeholder="Name" id="cardNameId" name="cardName" required>
                        <br>
                        <label for="cardRulesId">Card Rules:</label>
                        <textarea id="cardRulesId" placeholder="Description" rows="4" cols="50"></textarea>

                        <label for="imageInput">Card Image:</label>
                        <input type="file" id="imageInput" name="cardImage" accept="image/*" required>
                
                    <div id="additionalCardInfo">
                        <div id="extraBirdInfo" class="">
                            <label for="addSubtypeInputId">Subtype:</label>
                            <input type="text" id="addSubtypeInputId" name="subTypeInput">
                            <label for="addCostInputId">Cost:</label>
                            <input type="text" id="addCostInputId" name="costInput">
                            <label for="addPowerInputId">Power:</label>
                            <input type="number" id="addPowerInputId" name="powerInput">
                        </div>
                        <div id="extraSongInfo" class = "hidden">
                            <label for="eggInputNumberId">Required Eggs:</label>
                            <input type="number" id="eggInputNumberId" name="eggInputNumber">
                            <label for="nestInputNumberId">Required Nest:</label>
                            <input type="number" id="nestInputNumberId" name="nestInputNumber">
                            <label for="airInputNumberId">Required Air:</label>
                            <input type="number" id="airInputNumberId" name="airInputNumber">
                            <label for="groundInputNumberId">Required Ground:</label>
                            <input type="number" id="groundInputNumberId" name="groundInputNumber">
                        </div>
                        <div id="extraFeatherInfo">

                        </div>
                        <div id="extraEggInfo">

                        </div>
                    </div>

                    
                    <label for="tagInputId">Tag:</label>
                    <input type="text" id="tagInputId" name="tagInput">
                    <p id="tagListP"></p>
                    <button type="button" id="addTagButton">Add Tag</button>

                    <button type="submit" form="inputForm">Submit</button>

                    <div class="confirmation-message-overlay" id="confirmationMessageOverlayId">
                        <div class="confirmation-message-container">
                        <div id="confirmationMessage">You Pressed A Button</div>
                        </div>
                    </div>

                    <br><br><br><br>
                    <button id="closeOverlayButton">Close</button>
                    </form>
                </div>
            </div>
            <div class="right-column" id="rightColumn">
                    <div class="add-image-container">
                        <img id="addImageBackground" src="card_images/Bird Template.png" alt="">
                        <img id = "addImagePreview" src="card_images/favicon.png" alt="Card"/>
                        <div class="text-box-card-power">
                            <h2 id="cardPowerTextId">0</h2>
                        </div>
                        <div class="text-box-card-name">
                            <h2 id="cardNameTitleTextId">Card Title</h2>
                        </div>
                        <div class="text-box-card-type">
                            <p id="cardTypeTextId">Card Type</p>
                        </div>
                        <div class="text-box-card-rules">
                            <p id="cardRulesTextId">Card Rules</p>
                        </div>
                    </div>
            </div>

          </div>
        </div>
      </div>




      <!-- THIS IS THE CARD QUEUE OVERLAY 'NOW PLAYING'-->

      <div id="queueOverlayId" class="queueOverlay">
        <button id="queueHamburgerButton" class="queue-hamburger-button">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>
        <div class="queue-overlay-content">
          <!-- Your menu items or content here -->
          <button id="printCardSheetId">Print the queue</button>
          <img src="card_images/blankCard.PNG" id="cardQueuePreviewId" alt="">
        </div>
      </div>
      


<!--  JAVASCRIPT below ------------------------------------------------------------------>



    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/json2csv"></script>

    <script type ="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
    import { getDatabase, ref as ref_database, push, set, onValue, query, onChildAdded, orderByChild, remove } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js";
    import { getStorage, ref as ref_storage, uploadBytes, getDownloadURL, listAll } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-storage.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut  } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
    // ------ I imported ref as ref_database/storage because having 2 refs gave an error

    
    let firebaseConfig = {};

    // Load the env variables to fill in the Firebase APIs
    function loadEnvVariables () {
        return fetch('/env')
        .then(response => response.json())
        .then(data => {
          // Use the environment variables in your client-side code
        // console.log(data)
          const tempFirebaseConfig = {
            apiKey: data.API_KEY,
            authDomain: data.AUTH_DOMAIN,
            projectId: data.PROJECT_ID,
            storageBucket: data.STORAGE_BUCKET,
            messagingSenderId: data.MESSAGING_SENDER_ID,
            appId: data.APP_ID
          };
          
          return tempFirebaseConfig;
        })
        .catch(error => {
          console.error('Error loading environment variables:', error);
        });
    }

    firebaseConfig = await loadEnvVariables();

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    //console.log(app);

    const database = getDatabase();
    //console.log(database);

    const storage = getStorage();
    //console.log(storage);

    const auth = getAuth(app);
    //console.log(auth)



    // Set the user's name in the corner
    auth.onAuthStateChanged(function(user) {
        const userIdContainer = document.getElementById('userIdContainer');
        if (user) {
            // User is signed in
            const dataRef = ref_database(database, 'Users/' + user.uid);

            onValue(dataRef, (snapshot) => {
                const data = snapshot.val();
                userIdContainer.textContent = data.name;
            })
            
        } else {
            // User is signed out
            userIdContainer.textContent = "";
        }
    });



    // DATA TYPE CARD and DECK
    class Card {
        constructor(type, pictureUrl, name, rules)
        {
            this.type = type;
            this.pictureUrl = pictureUrl;
            this.name = name;
            this.rules = rules;
        }

        sayHi(){
            console.log(this.type, + ' ' + this.name, + ' ' + this.rules)
        }
    }

    const icon = document.getElementById("iconTopPage");
    // const card1 = new Card("feather", icon.getAttribute('src'), "Feathercard", "Feather rules");

    // DATA TYPE DECK
    class Deck {
        constructor()
        {
            this.cards = [];
        }

        addCard(card) {
            this.cards.push(card);
        }
    }

    const deck1 = new Deck();

    function addToDeck()
    {
        console.log(card1);
        deck1.addCard(card1);
        console.log(deck1);
    }

    document.getElementById("cardQueuePreviewId").addEventListener("click", function() {
        addToDeck();
    });


    // AUTHENTICATION CHECK TO DISPLAY CARDS ON THE FRONT PAGE, DELAYED TO LOAD FIREBASE DATA
    // let isAdmin = false;
    // // CHECK IF USER IS AN ADMIN BEFORE ANYTHING HAPPENS
    // const userRef = ref_database(database, 'Users/' + auth + "/admin");
    // onValue(userRef, (snapshot) => {
    //     if (admin)
    //     {
    //         isAdmin = true;
    //     }
    // });


    
    // DISPLAY ALL THE IMAGES IN STORAGE WHEN YOU OPEN THE PAGE (displays 5 random cards right now)
    let isAdmin = false;
    function checkUserLoggedIn() {
    // Delay the execution of the onAuthStateChanged callback function
        setTimeout(() => {
            auth.onAuthStateChanged((user) => {

                    if (user) {
                        // User is logged in, call your function to display the cards or perform other actions
                        
                        const dataRef = ref_database(database, 'Users/' + user.uid);

                        onValue(dataRef, (snapshot) => {
                            const data = snapshot.val();
                            
                            if (data.admin == true)
                            {
                                //console.log('truth');
                                isAdmin = true;
                                displayCards('false'); // Don't shuffle the cards on home screen
                            }


                        });

                        // onValue(dataRef, (snapshot) => {
                        //     const data = snapshot.val;
                        //     console.log(data.admin);
                        // });
                    }

                });

            }, 1000); // Change 3000 to the number of milliseconds you want to delay (e.g., 3000 milliseconds = 3 seconds)
    }

    // Start the delayed authentication check
    checkUserLoggedIn();









    // auth.onAuthStateChanged (function(user) {
    //     if (user) {
    //         displayCards('true');
    //     }
    // });

    

    function displayCards(isRandom) {

        if (isAdmin) {
            const storageRef = ref_storage(storage, 'images/');

            const imageUrls = [];
            
            // Get a list of everything in storage, update image array
            listAll(storageRef)
                .then((res) => {
                const promises = res.items.map((itemRef) => {
                    // Track the itemRef
                    //console.log(itemRef.name);

                    return getDownloadURL(itemRef).catch((error) => {
                    console.log('Error retrieving download URL:', error);
                    });
                });
                
                return Promise.all(promises).then( (urls) => {
                    return { urls, res };
                });
                })
                .then(({urls, res}) => {
                    imageUrls.push(...urls);
                    //console.log(imageUrls);


                    const imageContainer = document.querySelector(".scroll-wrapper");
                    imageContainer.innerHTML = '';

                    const shuffledImgUrls = imageUrls;

                    if (isRandom === 'true'){
                        // Shuffle and cut the available cards
                        const shuffledImgUrls = shuffleArray(imageUrls);
                        if (shuffledImgUrls.length > 5) {
                            shuffledImgUrls.splice(5);
                        }
                    }

                    // Dynamically create the <img> elements and append them to the container
                    shuffledImgUrls.forEach((imageUrl, index) => {
                        const imgElement = document.createElement("img");
                        imgElement.setAttribute('src', imageUrl);
                        

                        const itemRef = res.items[index];
                        
                        const dataRef = ref_database(database, 'Cards/' + itemRef.name);

                        

                        onValue(dataRef, (snapshot) => {
                            const info = snapshot.val();
                           
                            imgElement.addEventListener("click", function() {

                                openCardDisplayHomeView(imgElement, info.name);

                            });
                        });
                        
                        
                        imgElement.alt = "Image";

                        imageContainer.appendChild(imgElement);
                    });
                })
                .catch((error) => {
                console.log('Error retrieving storage files:', error);
                });

        }
    }
    
    
    // Shuffle array for the scroll image display
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }


    function displayCards2() {
        const dataRef = ref_database(database, 'Cards/');

        const imageContainer = document.querySelector(".scroll-wrapper");
        imageContainer.innerHTML = '';

        const cardIds = [];

        onChildAdded(dataRef, (snapshot) => {

            const cardData = snapshot.val();
            const cardId = snapshot.key;

            cardIds.push(cardId);
            
        });

        
        const shuffledCardIds = shuffleArray(cardIds);
        console.log(shuffledCardIds,length);

        shuffledCardIds.forEach((id, index) => {

            const cardImageRef = ref_storage(storage, 'images/' + id);
            console.log(id);
            const imgElement = document.createElement("img");

            getDownloadURL(cardImageRef)
                .then((url) => {
                    imgElement.setAttribute('src', url);
                })
                .catch((error) => {
                    // Handle any errors
                });

                imgElement.alt = "Image";

                imgElement.addEventListener("click", function() {
                    openCardDisplayHomeView(imgElement, cardId);
                });

                imageContainer.appendChild(imgElement);

        });




        
            // const newCardImageRef = ref_storage(storage, 'images/' + cardId);
            // const imgElement = document.createElement("img");

            // getDownloadURL(newCardImageRef)
            //             .then((url) => {
            //                 imgElement.setAttribute('src', url);
            //             })
            //             .catch((error) => {
            //                 // Handle any errors
            //             });
    
            // imgElement.alt = "Image";

            // imgElement.addEventListener("click", function() {
            //     openCardDisplayHomeView(imgElement, cardId);
            // });
            
            // imageContainer.appendChild(imgElement);
            
       

        // // Get a list of everything in storage, update image array
        // listAll(storageRef)
        //     .then((res) => {
        //     const promises = res.items.map((itemRef) => {
        //         // Track the itemRef
        //         //console.log(itemRef.name);

        //         return getDownloadURL(itemRef).catch((error) => {
        //            console.log('Error retrieving download URL:', error);
        //          });
        //      });
            
        //     return Promise.all(promises).then( (urls) => {
        //         return { urls, res };
        //     });
        //     })
        //     .then(({urls, res}) => {
        //         imageUrls.push(...urls);
        //         //console.log(imageUrls);


        //         const imageContainer = document.querySelector(".scroll-wrapper");
        //         imageContainer.innerHTML = '';

        //         // Shuffle the available cards
        //         const shuffledImgUrls = shuffleArray(imageUrls);
        //         if (shuffledImgUrls.length > 5) {
        //             shuffledImgUrls.splice(5);
        //         }


        //         // Dynamically create the <img> elements and append them to the container
        //         shuffledImgUrls.forEach((imageUrl, index) => {
        //             const imgElement = document.createElement("img");
        //             imgElement.setAttribute('src', imageUrl);

        //             const itemRef = res.items[index];
                    
        //             const dataRef = ref_database(database, 'Cards/' + itemRef.name);
        //             onValue(dataRef, (snapshot) => {
        //                 const info = snapshot.val();
        //                 imgElement.addEventListener("click", function() {
                            
        //                     openCardDisplayHomeView(imgElement, info.name);
        //                 });
        //             });
                    
        //             imgElement.alt = "Image";

        //             imageContainer.appendChild(imgElement);
        //         });
        //     })
        //     .catch((error) => {
        //     console.log('Error retrieving storage files:', error);
        //     });

        
    }
    
































    // //  READS INFO FROM THE DATABASE AND SAVES TO TXT
    // document.getElementById("viewButton").addEventListener("click", viewDB);
    // function viewDB() {
        
    //     const DataRef = ref_database(database, '/Cards');
    //     onValue(DataRef, (snapshot) => {
    //         const jsonData = snapshot.val();
    //         //console.log(jsonData); // JSON representation of the database

    //         const csvData = json2csv.parse(jsonData);
    //         //console.log(csvData);

    //         const combinedDataArray = []; // Array to accumulate the data

    //                 for (const key in jsonData) {
    //                     if (jsonData.hasOwnProperty(key)) {
    //                         const element = jsonData[key];
    //                         const csvData2 = json2csv.parse(element);

    //                         const dataArray = csvData2.split('\n');
    //                         const dataElement1 = dataArray[1];
    //                         const newDataArray = dataElement1.split('[');
    //                         const newDataElement1 = newDataArray[1];
    //                         const dataArray2 = newDataElement1.split(']');

    //                         const modifiedElement1 = dataArray[0].replace(/"([^"]*)"/g, (match, content) => {
    //                             // Perform desired modifications on the matched content
    //                             return content; // Example: Convert the content to uppercase
    //                         });
                            
    //                         const modifiedElement2 = newDataArray[0].replace(/"([^"]*)"/g, (match, content) => {
    //                             // Perform desired modifications on the matched content
    //                             return content; // Example: Convert the content to uppercase
    //                         });

    //                         const modifiedElement3 = dataArray2[0].replace(/"([^"]*)"/g, (match, content) => {
    //                             // Perform desired modifications on the matched content
    //                             return content; // Example: Convert the content to uppercase
    //                         });

    //                         const modifiedElement4 = dataArray2[1].replace(/"([^"]*)"/g, (match, content) => {
    //                             // Perform desired modifications on the matched content
    //                             return content; // Example: Convert the content to uppercase
    //                         });

    //                         const parsedMod2 = newDataArray[0].slice(0, -2);
    //                         const parsedMod4 = modifiedElement4.replace(/[, "]/g, '').trim();
                            
                            

    //                         const finalDataArray = [];
    //                         finalDataArray.push(modifiedElement1, parsedMod2, modifiedElement3, parsedMod4);

    //                         console.log(finalDataArray);
    //                         //console.log(dataArray);
    //                         combinedDataArray.push(...finalDataArray); // Accumulate the data
    //                     }
    //                 }
                
    //                 function downloadArrayAsTextFile(array, fileName) {
    //                     const data = array.join('\n');

    //                     const blob = new Blob([data], { type: 'text/plain' });
    //                     const url = URL.createObjectURL(blob);

    //                     const link = document.createElement('a');
    //                     link.href = url;
    //                     link.download = fileName;
    //                     link.click();
    //                 }

    //                 downloadArrayAsTextFile(combinedDataArray, "backup.txt");



                    






    //         // for (const key in jsonData) {
    //         //     if (jsonData.hasOwnProperty(key)) {
    //         //         const element = jsonData[key];
    //         //         // Perform the desired action for each element

    //         //         const csvData2 = json2csv.parse(element);
                    
    //         //         // Split the CSV data by commas
    //         //         const dataArray = csvData2.split(',');

    //         //        // console.log(dataArray);
                   
    //         //     //    const combinedDataArray = []; // Array to accumulate the data

                    
    //         //     //     if (jsonData.hasOwnProperty(key)) {
    //         //     //         const element = jsonData[key];
    //         //     //         const csvData2 = json2csv.parse(element);
    //         //     //         const dataArray = csvData2.split(',');

    //         //     //         combinedDataArray.push(...dataArray); // Accumulate the data
    //         //     //     }
                    
                
    //         //     //     function downloadArrayAsTextFile(array, fileName) {
    //         //     //         const data = array.join(',');

    //         //     //         const blob = new Blob([data], { type: 'text/plain' });
    //         //     //         const url = URL.createObjectURL(blob);

    //         //     //         const link = document.createElement('a');
    //         //     //         link.href = url;
    //         //     //         link.download = fileName;
    //         //     //         link.click();
    //         //     //         }

    //         //     //     downloadArrayAsTextFile(combinedDataArray, "backup.txt");

    //         //         // // Usage example:
    //         //         // const dataArray = ["item1", "item2", "item3"];
    //         //         // const fileName = "data.txt";

    //         //         // downloadArrayAsTextFile(dataArray, fileName);




    //         //     }
    //         //  }
           
    //     });


        


    // }

    // function viewStorage() {

    //     const storRef = ref_storage(storage, '/images');
    //     const imageUrls = [];
    //     const zip = new JSZip();

    //     listAll(storRef)
    //         .then((res) => {
    //         const promises = res.items.map((itemRef) => {
    //             // Track the itemRef
    //             //console.log(itemRef.name);

    //             return getDownloadURL(itemRef).catch((error) => {
    //                console.log('Error retrieving download URL:', error);
    //              });
    //          });
            
    //         return Promise.all(promises).then( (urls) => {
    //             return { urls, res };
    //         });
    //         })
    //         .then(({urls, res}) => {
    //             imageUrls.push(...urls);
    //             //console.log(imageUrls);


    //             // Dynamically create the <img> elements and append them to the container
    //             imageUrls.forEach((imageUrl, index) => {
    //                 const itemRef = res.items[index];
    //                 console.log(imageUrl);
    //                 //downloadImageFromFirebase(imageUrl, itemRef.name + ".png");

                    
    //                 // const imgElement = document.createElement("img");
    //                 // imgElement.setAttribute('src', imageUrl);
    //                 // console.log(imgElement);

    //                 // const link = document.createElement('a');
    //                 // link.href = imgElement;
    //                 // link.download = itemRef.name + '.png';
    //                 // link.click();
                    
                    
    //                 // const dataRef = ref_database(database, 'Cards/' + itemRef.name);
    //                 // onValue(dataRef, (snapshot) => {
    //                 //     const info = snapshot.val();
    //                 //     imgElement.addEventListener("click", function() {
    //                 //         openCardDisplayHomeView(imgElement, info.type, itemRef.name, info.power, info.rules);
    //                 //     });
    //                 // });
                    
    //                 // imgElement.alt = "Image";

    //                 // imageContainer.appendChild(imgElement);
    //             });
    //         })
    //         .catch((error) => {
    //         console.log('Error retrieving storage files:', error);
    //         });

    // }

    // function downloadImageFromFirebase(url, fileName) {
    //     const ref = ref_storage(storage, url);
    //     getDownloadURL(ref)
    //         .then(downloadUrl => downloadUrl.blob())
    //         .then(blob => {
    //             const newDownloadUrl = URL.createObjectURL(blob);
    //             const link = document.createElement('a');
    //             link.href = newDownloadUrl;
    //             link.download = fileName;
    //             link.target = '_blank';
    //             link.click();
    //         })
    //         .catch(error => {
    //         console.error('Error downloading image from Firebase:', error);
    //         });
    //     }



    // // PULL TEXT FILE AND UPDATE THE DB WITH ITS PARSED INFORMATION
    // document.getElementById("updateButton").addEventListener("click", function (event) {
    //     const fileInput = document.getElementById("updateInputTextId");
    //     if (fileInput.files.length > 0) {
    //         const file = fileInput.files[0];
    //         const reader = new FileReader();
    //         reader.onload = function(e) {
    //             const fileContent = e.target.result;
    //             // Handle the file content here
    //             //console.log(fileContent);
               
    //             // Parse the file content here

    //             const lines = fileContent.trim().split('\n');
                

    //             if (lines.length >= 2) {
    //                 const headers = lines[0].split(',');

    //                 //console.log(headers);
    //                 const dataLines = lines.slice(1); // Exclude the header line
    //                 //console.log(dataLines);

    //                 dataLines.forEach(dataLine => {
    //                     const data = dataLine.split(',');
                        



    //                     const regex = /(\[.*?\])/;
    //                     const matches = dataLine.match(regex);

    //                     if (matches && matches.length > 0) {
    //                         const arrayString = matches[0];
    //                         console.log(arrayString);
    //                         //const parsedArray = JSON.parse(arrayString);
    //                     } else {
    //                     console.error('No array found in the text.');
    //                     }
                        





    //                     console.log("Data: " + data.length + ", Header: " + headers.length);

    //                     if (data.length === headers.length) {

                            
    //                         for (let i = 0; i < headers.length; i++) {

    //                             console.log(headers[i].trim() + ': ' + data[i].trim());

    //                         }
    //                     } else {
    //                         console.error('Mismatch between headers and data in line: ' + dataLine);
    //                     }
    //                 });

    //             } else {
    //                 console.error('Invalid file format');
    //             }


    //         };
    //         reader.readAsText(file);
    //     }
    // });








    // MAKE SEARCHES VISIBLE
    let searchToggleState = false;
    document.getElementById("toggleSearchButton").addEventListener("click", function (event) {
            const button = document.getElementById("toggleSearchButton");
            const formsContainer = document.getElementById("searchFormsContainer");
            const forms = document.getElementsByClassName("search-form");

            if (searchToggleState) {
                button.style.left = "50%";
                formsContainer.style.left = "100%";
                searchToggleState = false;
            }
            else {
                button.style.left = "10%";
                formsContainer.style.left = "20%";
                searchToggleState = true;
                
                for (let i = 0; i < forms.length; i++) {
                    forms[i].style.display = "block";
                }
            }
    });


    // SEARCH AND UPDATE IMAGE WHEEL FUNCTIONS (DEPRECATED)
    
    // document.getElementById("titleSearchForm").addEventListener("submit", function(event) {
    //     event.preventDefault(); // Prevent form submission and page reload
    //     titleSearchDB();
    //     //updateCardWheel();
    // });

    function titleSearchDB() {
        const storageRef = ref_storage(storage, 'images/');

        const imageUrls = [];
        
        const searchInputValue = document.getElementById('titleSearchPrompt').value;

        // Get a list of everything in storage, update image array
        listAll(storageRef)
            .then((res) => {
            const promises = res.items.map((itemRef) => {
                // Track the itemRef
                //console.log(itemRef.name);

                return getDownloadURL(itemRef).catch((error) => {
                   console.log('Error retrieving download URL:', error);
                 });
             });
            
            return Promise.all(promises).then( (urls) => {
                return { urls, res };
            });
            })
            .then(({urls, res}) => {
                imageUrls.push(...urls);
                

                const imageContainer = document.querySelector(".scroll-wrapper");
                imageContainer.innerHTML = '';

                // Dynamically create the <img> elements and append them to the container
                imageUrls.forEach((imageUrl, index) => {

                    
                    const itemRef = res.items[index];

                    const itemRefString = JSON.stringify(itemRef.name);
                    
                    // This is the search parameter
                    if (itemRefString.includes(searchInputValue))
                    {
                        const imgElement = document.createElement("img");
                        imgElement.setAttribute('src', imageUrl);
                        
                        const dataRef = ref_database(database, 'Cards/' + itemRef.name);
                        onValue(dataRef, (snapshot) => {
                            const info = snapshot.val();
                            imgElement.addEventListener("click", function() {
                                openCardDisplayHomeView(imgElement, itemRef.name, info.power, info.rules);
                            });
                        });
                        
                        imgElement.alt = "Image";

                        imageContainer.appendChild(imgElement);
                    }

                });
            })
            .catch((error) => {
            console.log('Error retrieving storage files:', error);
            });

    }

    // document.getElementById("typeSearchForm").addEventListener("submit", function(event) {
    //     event.preventDefault(); // Prevent form submission and page reload
    //     typeSearchDB();
    //     //updateCardWheel();
    // });

    function typeSearchDB() {
        const searchInputValue = document.getElementById('typeSearchPrompt').value;

        const imageContainer = document.querySelector(".scroll-wrapper");
        imageContainer.innerHTML = '';

        const cardsRef = ref_database(database, 'Cards');

        // Query the database based on the search input value
        onChildAdded(cardsRef, (snapshot) => {
            const cardData = snapshot.val();
            const cardId = snapshot.key;

            if (cardData && cardData.type === searchInputValue) {
                const newCardImageRef = ref_storage(storage, 'images/' + cardId);
                const imgElement = document.createElement("img");

                getDownloadURL(newCardImageRef)
                            .then((url) => {
                                imgElement.setAttribute('src', url);
                            })
                            .catch((error) => {
                                // Handle any errors
                            });
        
                imgElement.alt = "Image";

                imgElement.addEventListener("click", function() {
                    openCardDisplay(imgElement, cardId, cardData.power, cardData.rules);
                });
                
                imageContainer.appendChild(imgElement);
            }
        });
    }

    // document.getElementById("tagSearchForm").addEventListener("submit", function(event) {
    //     event.preventDefault(); // Prevent form submission and page reload
    //     tagSearchDB();
    //     //updateCardWheel();
    // });

    function tagSearchDB() {
        const searchInputValue = document.getElementById('tagSearchPrompt').value;

        const imageContainer = document.querySelector(".scroll-wrapper");
        imageContainer.innerHTML = '';

        const cardsRef = ref_database(database, 'Cards');

        const imageUrls = [];



        // Query the database based on the search input value
        onChildAdded(cardsRef, (snapshot) => {
            const cardData = snapshot.val();
            const cardId = snapshot.key;


            // For each card in the db, get a reference and list the ones with certain tags
            const newCardRef = ref_database(database, 'Cards/' + cardId + '/tags');

            onChildAdded(newCardRef, (newSnapShot) => {

                const newCardData = newSnapShot.val();
                const newCardId = newSnapShot.key;

                
                if (newCardData === searchInputValue) {
                    const newCardImageRef = ref_storage(storage, 'images/' + cardId);
                    const imgElement = document.createElement("img");

                    getDownloadURL(newCardImageRef)
                        .then((url) => {
                            imgElement.setAttribute('src', url);
                        })
                        .catch((error) => {
                            // Handle any errors
                        });


                    
                    imgElement.alt = "Image";

                    imgElement.addEventListener("click", function() {
                        openCardDisplayHomeView(imgElement, cardId, cardData.power, cardData.rules);
                    });
                    
                    imageContainer.appendChild(imgElement);
                }

            })

            




        });
}



    // TRUE SEARCH BUTTON
    document.getElementById("searchCardsButton").addEventListener("click", function (event) {
        if (isAdmin)
        {
            searchDB();
        }
    });

    function searchDB() {
        const titleInputValue = document.getElementById('titleSearchPrompt').value;
        const typeInputValue = document.getElementById('typeSearchPrompt').value;
        const tagInputValue = document.getElementById('tagSearchPrompt').value;

        const imageContainer = document.querySelector(".scroll-wrapper");
        imageContainer.innerHTML = '';

        const cardsRef = ref_database(database, 'Cards');

        const imageUrls = [];

            

        // Query all Cards in database based on the search input value
        onChildAdded(cardsRef, (snapshot) => {
            const cardData = snapshot.val();
            const cardId = snapshot.key;

            const cardTitleString = JSON.stringify(cardData.name);

            // For each card in the db, get a reference for each searchable field
            // Start by searching Title, then Type, then Tags


            // If Title isn't blank
            if (titleInputValue !== '') {

                // If Title searched is in the DB
                if (cardData && cardTitleString.includes(titleInputValue)) {




                    // If Type select isn't blank
                    if (typeInputValue !== '') {


                        // If Type selected is in the DB
                        if (cardData.type === typeInputValue) {




                            // If Tag search isn't blank
                            if (tagInputValue !== '') {

                                const tagCardRef = ref_database(database, 'Cards/' + cardId + '/tags');
                                onChildAdded(tagCardRef, (newSnapShot) => {

                                    const newCardData = newSnapShot.val();
                                    const newCardId = newSnapShot.key;


                                    // If this card that matches Title and any Tags is in there, make imgs
                                    if (newCardData === tagInputValue) {

                                        const newCardImageRef = ref_storage(storage, 'images/' + cardId);
                                        const imgElement = document.createElement("img");

                                        getDownloadURL(newCardImageRef)
                                            .then((url) => {
                                                imgElement.setAttribute('src', url);
                                            })
                                            .catch((error) => {
                                                // Handle any errors
                                            });


                                        
                                        imgElement.alt = "Image";

                                        imgElement.addEventListener("click", function() {
                                            openCardDisplayHomeView(imgElement, cardId, cardData.power, cardData.rules);
                                        });
                                        
                                        imageContainer.appendChild(imgElement);
                                    }

                                });


                            }
                            else { // Title and Type are matched, Tag is blank

                                const newCardImageRef = ref_storage(storage, 'images/' + cardId);
                                const imgElement = document.createElement("img");

                                getDownloadURL(newCardImageRef)
                                    .then((url) => {
                                        imgElement.setAttribute('src', url);
                                    })
                                    .catch((error) => {
                                        // Handle any errors
                                    });


                                
                                imgElement.alt = "Image";

                                imgElement.addEventListener("click", function() {
                                    openCardDisplayHomeView(imgElement, cardId, cardData.power, cardData.rules);
                                });
                                
                                imageContainer.appendChild(imgElement);
                            }



                        }

                    }
                    else { // If Type select is blank, but title is in DB

                        // If Tag search isn't blank
                        if (tagInputValue !== '') {

                            const tagCardRef = ref_database(database, 'Cards/' + cardId + '/tags');
                            onChildAdded(tagCardRef, (newSnapShot) => {

                                const newCardData = newSnapShot.val();
                                const newCardId = newSnapShot.key;


                                // If this card that matches Title and any Tags is in there, make imgs
                                if (newCardData === tagInputValue) {

                                    const newCardImageRef = ref_storage(storage, 'images/' + cardId);
                                    const imgElement = document.createElement("img");

                                    getDownloadURL(newCardImageRef)
                                        .then((url) => {
                                            imgElement.setAttribute('src', url);
                                        })
                                        .catch((error) => {
                                            // Handle any errors
                                        });


                                    
                                    imgElement.alt = "Image";

                                    imgElement.addEventListener("click", function() {
                                        openCardDisplayHomeView(imgElement, cardId, cardData.power, cardData.rules);
                                    });
                                    
                                    imageContainer.appendChild(imgElement);
                                }

                            });


                        }
                        else { // Type and tag select are blank, title is in DB

                            const newCardImageRef = ref_storage(storage, 'images/' + cardId);
                            const imgElement = document.createElement("img");

                            getDownloadURL(newCardImageRef)
                                .then((url) => {
                                    imgElement.setAttribute('src', url);
                                })
                                .catch((error) => {
                                    // Handle any errors
                                });


                            
                            imgElement.alt = "Image";

                            imgElement.addEventListener("click", function() {
                                openCardDisplay(imgElement, cardId, cardData.power, cardData.rules);
                            });
                            
                            imageContainer.appendChild(imgElement);
                        }


                    }



                }
                

            }

            else { // If the Title search is blank
                

                // If Type select isn't blank
                if (typeInputValue !== '') {


                // If Type selected is in the DB
                if (cardData.type === typeInputValue) {

                    console.log(typeInputValue);


                    // If Tag search isn't blank
                    if (tagInputValue !== '') {

                        const tagCardRef = ref_database(database, 'Cards/' + cardId + '/tags');
                        onChildAdded(tagCardRef, (newSnapShot) => {

                            const newCardData = newSnapShot.val();
                            const newCardId = newSnapShot.key;


                            // If this card that matches Title and any Tags is in there, make imgs
                            if (newCardData === tagInputValue) {

                                const newCardImageRef = ref_storage(storage, 'images/' + cardId);
                                const imgElement = document.createElement("img");

                                getDownloadURL(newCardImageRef)
                                    .then((url) => {
                                        imgElement.setAttribute('src', url);
                                    })
                                    .catch((error) => {
                                        // Handle any errors
                                    });


                                
                                imgElement.alt = "Image";

                                imgElement.addEventListener("click", function() {
                                    openCardDisplayHomeView(imgElement, cardId, cardData.power, cardData.rules);
                                });
                                
                                imageContainer.appendChild(imgElement);
                            }

                        });


                    }
                    else { // Title is blank, Tag is blank, Type is correct, return all of said type

                        const newCardImageRef = ref_storage(storage, 'images/' + cardId);
                        const imgElement = document.createElement("img");

                        getDownloadURL(newCardImageRef)
                            .then((url) => {
                                imgElement.setAttribute('src', url);
                            })
                            .catch((error) => {
                                // Handle any errors
                            });


                        
                        imgElement.alt = "Image";

                        imgElement.addEventListener("click", function() {
                            openCardDisplay(imgElement, cardId, cardData.power, cardData.rules);
                        });
                        
                        imageContainer.appendChild(imgElement);
                    }



                }

                }
                else { // If Type select is blank and title is blank, search tags

                // If Tag search isn't blank
                if (tagInputValue !== '') {

                    const tagCardRef = ref_database(database, 'Cards/' + cardId + '/tags');
                    onChildAdded(tagCardRef, (newSnapShot) => {

                        const newCardData = newSnapShot.val();
                        const newCardId = newSnapShot.key;


                        // If this card that matches Title and any Tags is in there, make imgs
                        if (newCardData === tagInputValue) {

                            const newCardImageRef = ref_storage(storage, 'images/' + cardId);
                            const imgElement = document.createElement("img");

                            getDownloadURL(newCardImageRef)
                                .then((url) => {
                                    imgElement.setAttribute('src', url);
                                })
                                .catch((error) => {
                                    // Handle any errors
                                });


                            
                            imgElement.alt = "Image";

                            imgElement.addEventListener("click", function() {
                                openCardDisplayHomeView(imgElement, cardId, cardData.power, cardData.rules);
                            });
                            
                            imageContainer.appendChild(imgElement);
                        }

                    });


                }
                


                }




            }

        });




    }









    // DISPLAY NOTES TAB, SET LISTENERS AND ADD NOTES
    document.getElementById("displayNotesId").addEventListener("click", function(event) {

        if (isAdmin) {

            const searchContainer = document.getElementById("searchBarContainer");
            searchContainer.style.display = "block";
            searchContainer.style.visibility = "visible";
            searchContainer.innerHTML = `
            <div class= "add-note-button-container">
                <button id="addNoteButtonId">Add Note</button>
            </div>
            `;

            // set the default page html
            const lowerPage = document.getElementById("lowerContentId");
            lowerPage.innerHTML = `
            <div class = "left-right-note-container">
                <div class = "left-note-page-container" id = "leftNotePageId">
                    
                </div>
                <div class = "right-note-page-container" id = "rightNotePageId">
                    
                </div>
            </div>
            `;

            const leftNotesPage = document.getElementById("leftNotePageId");
            const rightNotesPage = document.getElementById("rightNotePageId");


            rightNotesPage.innerHTML = `
                    
            <p id="notePreviewParagraph"></p>

            `;

            const paragraphPreview = document.getElementById("notePreviewParagraph");

            

            // load the current notes in the db
            const notesRef = ref_database(database, 'Notes');

            onChildAdded(notesRef, (snapshot) => {
                const noteData = snapshot.val();
                const noteId = snapshot.key;

                const btnElement = document.createElement("button");
                btnElement.id = "openNoteButtonId";
                btnElement.textContent = noteData.title;
                btnElement.addEventListener("click", function() {
                    rightNotesPage.innerHTML = `
                        <p id="notePreviewParagraph"></p>
                        <button id="editNoteButtonId">Edit</button>
                    `;

                    document.getElementById("editNoteButtonId").addEventListener("click", function() {
                        rightNotesPage.innerHTML = `
                        <input type="text" id="addNoteTitleText" placeholder="Title" value="` + noteData.title + `">
                        <textarea id="addNotePreviewTextarea">` + noteData.content + `</textarea>
                        <button id ="addNoteToDatabaseId">Add</button>
                        <button id ="cancelAddNewNoteButton">Cancel</button>
                    `;

                        // Set a listener on the add note button
                        const inputTextarea = document.getElementById("addNotePreviewTextarea");
                        const inputTitleText = document.getElementById("addNoteTitleText");

                        const uploadNoteButton = document.getElementById("addNoteToDatabaseId");
                        uploadNoteButton.addEventListener("click", function() {
                            const inputText = inputTextarea.value;
                            const inputTitle = inputTitleText.value;

                            // Set the date and DB ID for updated note
                            const currentTime = new Date();
                            const stringTime = "" + currentTime;

                            // Upload the note to the database
                            const dataRef = ref_database(database, 'Notes/' + noteId);
                            const data = {
                                        title: inputTitle,
                                        content: inputText,
                                        user: 'Testuser',
                                        created: "" + noteData.created,
                                        updated: stringTime
                                    }

                                    set(dataRef, data);

                                    console.log('Data set');

                                    rightNotesPage.innerHTML = `
                                    <p>` + inputText + `</p>
                                    `;
                        });

                        // Set listener on the Cancel button
                        const cancelAddNoteButton = document.getElementById("cancelAddNewNoteButton");
                        cancelAddNoteButton.addEventListener("click", function() {
                            rightNotesPage.innerHTML = `
                            <p id="notePreviewParagraph">` + noteData.content +`</p>
                            `;
                        });


                    });

                    const paragraphPreview = document.getElementById("notePreviewParagraph");
                    paragraphPreview.textContent = noteData.content;
                    //showNoteOnPage();

                });

                leftNotesPage.appendChild(btnElement);


            });

            
            // Set listener on add note button
            const addNoteButton = document.getElementById("addNoteButtonId");
            addNoteButton.addEventListener("click", function() {
                rightNotesPage.innerHTML = `
                <input type="text" id="addNoteTitleText" placeholder="Title" ></input>
                <textarea id="addNotePreviewTextarea" placeholder="Fill out the note"></textarea>
                <button id ="addNoteToDatabaseId">Add</button>
                `;

                // Set a listener on the upload new note button
                const inputTextarea = document.getElementById("addNotePreviewTextarea");
                const inputTitleText = document.getElementById("addNoteTitleText");

                const uploadNoteButton = document.getElementById("addNoteToDatabaseId");
                uploadNoteButton.addEventListener("click", function() {
                    const inputText = inputTextarea.value;
                    const inputTitle = inputTitleText.value;

                    // Set the date and DB ID for each new note
                    const currentTime = new Date();
                    const noteKeyId = inputTitle + " - " + currentTime;
                    const stringTime = "" + currentTime;

                    // Upload the note to the database
                    const dataRef = ref_database(database, 'Notes/' + noteKeyId);
                    const data = {
                                title: inputTitle,
                                content: inputText,
                                user: 'Testuser',
                                created: stringTime,
                                updated: stringTime
                            }

                            set(dataRef, data);

                            console.log('Data set');
                            
                            rightNotesPage.innerHTML = `
                            <p>Note successfully added.</p>
                            
                            `;
                            // TO DO, RIGHT ABOVE: Refresh the particular button whose data was changed




                            // 


                });

            });

        }

    });









    // DISPLAY HOME/SCROLL VIEW ALL DB
    document.getElementById("displayScrollWrapperId").addEventListener("click", function(event) {

        if (isAdmin) {

            searchToggleState = false;
            // Reset the Search HTML
            const searchContainer = document.getElementById("searchBarContainer");
            searchContainer.style.display = "block";
            searchContainer.style.visibility = "visible";
            searchContainer.innerHTML = `
            <div id="toggleSearchButton" class="toggle-search-button">
                        <img src="card_images/searchIcon.png" id="searchIconId" alt="">
                    </div>
                    <div id="searchFormsContainer" class="search-forms-container">
                        
                    <div class="search-input-container">
                        <input type="text" placeholder="Title" id="titleSearchPrompt">
                        
                        <input type="text" placeholder="Type" id="typeSearchPrompt">
                        
                        <input type="text" placeholder="Tags" id="tagSearchPrompt">
                    </div>
                        <button type="submit" id="searchCardsButton">SEARCH</button>
                    </div>
            `;

            document.getElementById("toggleSearchButton").addEventListener("click", function (event) {
                    const button = document.getElementById("toggleSearchButton");
                    const formsContainer = document.getElementById("searchFormsContainer");
                    const forms = document.getElementsByClassName("search-form");

                    if (searchToggleState) {
                        button.style.left = "50%";
                        formsContainer.style.left = "100%";
                        searchToggleState = false;
                    }
                    else {
                        button.style.left = "10%";
                        formsContainer.style.left = "20%";
                        searchToggleState = true;
                        
                        for (let i = 0; i < forms.length; i++) {
                            forms[i].style.display = "block";
                        }
                    }
            });


            document.getElementById("searchCardsButton").addEventListener("click", function (event) {
                searchDB();
            });



            const lowerPage = document.getElementById("lowerContentId");

            lowerPage.innerHTML = `
            <div class="scroll-wrapper" id = "scrollWrapperId">
            </div>
            `;

            displayCards();

        }

    });

    // DISPLAY RANDOM CARD HOME PAGE
    document.getElementById("displayScrollWrapperRandomId").addEventListener("click", function(event) {

        if (isAdmin) {

            searchToggleState = false;
            // Reset the Search HTML
            const searchContainer = document.getElementById("searchBarContainer");
            searchContainer.style.display = "block";
            searchContainer.style.visibility = "visible";
            searchContainer.innerHTML = `
            <div id="toggleSearchButton" class="toggle-search-button">
                        <img src="card_images/searchIcon.png" id="searchIconId" alt="">
                    </div>
                    <div id="searchFormsContainer" class="search-forms-container">
                        
                    <div class="search-input-container">
                        <input type="text" placeholder="Title" id="titleSearchPrompt">
                        
                        <input type="text" placeholder="Type" id="typeSearchPrompt">
                        
                        <input type="text" placeholder="Tags" id="tagSearchPrompt">
                    </div>
                        <button type="submit" id="searchCardsButton">SEARCH</button>
                    </div>
            `;
            document.getElementById("toggleSearchButton").addEventListener("click", function (event) {
                    const button = document.getElementById("toggleSearchButton");
                    const formsContainer = document.getElementById("searchFormsContainer");
                    const forms = document.getElementsByClassName("search-form");

                    if (searchToggleState) {
                        button.style.left = "50%";
                        formsContainer.style.left = "100%";
                        searchToggleState = false;
                    }
                    else {
                        button.style.left = "10%";
                        formsContainer.style.left = "20%";
                        searchToggleState = true;
                        
                        for (let i = 0; i < forms.length; i++) {
                            forms[i].style.display = "block";
                        }
                    }
            });

            document.getElementById("searchCardsButton").addEventListener("click", function (event) {
                searchDB();
            });
            
            const lowerPage = document.getElementById("lowerContentId");

            lowerPage.innerHTML = `
            <div class="scroll-wrapper" id = "scrollWrapperId">
            </div>
            `;
            
            // Display the scroll wrapper with Random parameter set to true
            displayCards('true');

        }

    });



    // DISPLAY DECK BUILDER LOWER PAGE
    document.getElementById("displayDecksButtonId").addEventListener("click", function(event) {

        if (isAdmin) {

            hamburgerMenu.classList.toggle('open');

            const lowerPage = document.getElementById("lowerContentId");
            const searchContainer = document.getElementById("searchBarContainer");
            searchContainer.style.display = "block";
            searchContainer.style.visibility = "visible";
            lowerPage.innerHTML = `
                <div class="scroll-wrapper" id = "scrollWrapperId">
                </div>
            `;
            searchContainer.innerHTML = `
                <div class="user-deck-container" id="userDeckContainerId">
                    <button id="createNewDeckButtonId">+</button>
                </div>
            `;

            // press the Create New Deck button
            document.getElementById("createNewDeckButtonId").addEventListener("click", function(event) {
                const imageContainer = document.querySelector(".scroll-wrapper");
                imageContainer.innerHTML = `

                <div class="deck-name-create-container">
                    <input id="newDeckTitleInputId" type="text" placeholder="Deck Name">
                    <button id="submitNewDeckId">CREATE</button>
                </div>

                `;


                // Send the created deck to the DB
                document.getElementById("submitNewDeckId").addEventListener("click", function(event) {
                    const deckTitle = document.getElementById("newDeckTitleInputId");
                    
                    // If user entered a name for the deck
                    if (deckTitle.value) {
                        
                        const deckRef = ref_database(database, 'Users/' + auth.currentUser.uid + '/Decks');

                        const deckData = {
                            name: deckTitle.value
                        }

                        push(deckRef, deckData);


                        imageContainer.innerHTML = ``;


                    }
                    else {
                        deckTitle.setAttribute('placeholder', 'ERROR: Name the Deck');
                    }

                });


            });

            // Check if Deck page is open before listening to User Decks
            const currentUser = auth.currentUser;
        
        
                    const userDeckContainer = document.getElementById('userDeckContainerId');
                    const imageContainer = document.querySelector(".scroll-wrapper");
                    imageContainer.innerHTML = '';


                    if (currentUser) {

                        // User is signed in
                        const dataRef = ref_database(database, 'Users/' + currentUser.uid + '/Decks');

                        // For each Deck,
                        onChildAdded(dataRef, (snapshot) => {
                            const data = snapshot.val();
                            const key = snapshot.key;

                            // MAKE BUTTONS FOR EACH DECK THAT CHANGE THE LOWER SCREEN TO A DECK VIEW
                            const btnElement = document.createElement("button");
                            btnElement.id = "expandDeckViewButtonId";
                            btnElement.textContent = data.name;
                            //console.log(data);



                            btnElement.addEventListener("click", function() {

                                // When you click each Deck button, it opens a scroll wrapper below with all the cards
                                imageContainer.textContent = '';

                                
                                const deckLength = Object.keys(data).length;
                                for (let i = 0; i < deckLength; i++) {
                                    
                                    // If the Deck's data is a number, it is a card (not the deck title)
                                    if (!isNaN(Number(Object.keys(data)[i]))) {
                                        const cardName = data[Object.keys(data)[i]];


                                        // Make each card an img with openCardDisplay as its listener

                                        const cardStorageRef = ref_storage(storage, 'images/' + cardName);

                                        

                                        getDownloadURL(cardStorageRef)
                                        .then((url) => {
                                            const imgElement = document.createElement("img");
                                            imgElement.setAttribute('src', url);
                                            
                                            const cardDataRef = ref_database(database, 'Cards/' + cardName);
                                            onValue(cardDataRef, (snapshot) => {
                                                const info = snapshot.val();
                                                imgElement.addEventListener("click", function() {
                                                    
                                                    openCardDisplayDeckView(imgElement, info.name, key); // 'key' passes to Deck Display as the Deck key
                                                });
                                            });
                                            
                                            imgElement.alt = "Image";

                                            imageContainer.appendChild(imgElement);

                                        })
                                        .catch((error) => {
                                            console.error("Error getting Firebase image");
                                        })
                                        
                                    }

                                }
                                
                            });


                            // Add each Deck's button to the upper container
                            userDeckContainer.appendChild(btnElement);

                        });
                        
                    } else {
                        // User is signed out
                        userDeckContainer.textContent = "Not logged in";
                    }
                

        }

    });


    // // DISPLAY PRINT SHEETS SCREEN
    // document.getElementById("printScreenButtonId").addEventListener("click", function(event) {
    //     const lowerContent = document.getElementById("lowerContentId");
    //     const searchContainer= document.getElementById("searchBarContainer");
    //     searchContainer.style.display = 'none';
    //     searchContainer.style.visibility = 'hidden';
    //     lowerContent.innerHTML = `

    //     <div class="print-sheet-button-container">
    //         <input type="file">
    //         <button id="createSheetButton">Create a sheet</button>
    //     </div>
    //     `;

    // });


































    // // DISPLAY BATTLEGROUND LOWER PAGE
    // document.getElementById("battleMenuButtonId").addEventListener("click", function(event) {





    //     if (isAdmin) {

    //         hamburgerMenu.classList.toggle('open');

    //         // Reset the HTML to blank/battleground
    //         const lowerPage = document.getElementById("lowerContentId");
    //         const searchContainer = document.getElementById("searchBarContainer");
            
    //         searchContainer.innerHTML = ``;
    //         searchContainer.style.display = "none";
    //         searchContainer.style.visibility = "hidden";

    //         lowerPage.style.width = "1500px";
    //         lowerPage.style.height = "850px";

    //         lowerPage.innerHTML = `
    //             <div class="battleground-container">

    //                 <div id="createJoinGameOverlay" class="create-join-game-overlay">
    //                         <div class="create-join-button-existing-dropdown-container">
    //                             <div class="create-game-button-container" id="createGameButtonContainer">
    //                                 <button id="createNewGameButton">Create New Game</button>
    //                                 <button id="joinGameButton">Join Game</button>
    //                                 <button id="spectateGameButton">Spectate Game</button>
    //                             </div>
                                
    //                             <div class="existing-games-container">
    //                                 <select id="existingGameSelectId">
    //                                     <!-- THIS IS WHERE GAMES FROM THE DB WILL SHOW UP --!>
    //                                 </select>
    //                             </div>

    //                         </div>
                        
    //                 </div>

    //                 <div id="playingField">

                        
                    

    //                     <img id="deckImageId" src="card_images/blankCard.png">

    //                 </div>
                    
                    
    //             </div>

            
            
    //         `;

    //         const gameMenuOverlay = document.getElementById("createJoinGameOverlay");
    //         gameMenuOverlay.style.display = 'block';

    //         // Create a new game
    //         document.getElementById("createNewGameButton").addEventListener("click", function(event) {
                
    //             const gameRef = ref_database(database, 'Games/');

    //             const newGame = {

    //                 // Continue to fill this out to resemble a perfect empty new game state
    //                 p1id: auth.currentUser.uid,
    //                 p1name: 'Jake',
    //                 p2name: 'Jeremy',
    //                 p1LP: 20,
    //                 p2LP: 20,
    //                 p1deck: {
    //                     0: 'Bird',
    //                     1: 'Bird 3'
    //                 },
    //                 p2field: {
    //                     0 :{
    //                         name: 'Bird',
    //                         inset: '24px'
    //                     },
    //                     1 :{
    //                         name: 'Bird',
    //                         inset: '32px'
    //                     }
    //                 }



    //             }

    //             // Create a new game in the database
    //             push(gameRef, newGame);

    //             // Open the battleground view with the loaded info



    //             // UPDATE THE PLAYING FIELD

    //             // Get a reference to each card that is in your Current Deck,
    //             // Fill the playingField deck with cards that match your Deck

    //             const playingField = document.getElementById("playingField");

    //             const currentDeck = '34tr3ert34te'; // TEST DATA - Allow user to choose in the future
    //             const userRef = ref_database(database, 'Users/' + auth.currentUser.uid + '/Decks/' + currentDeck);

    //             onChildAdded(userRef, (snapshot) => {
    //                 const data = snapshot.val();
    //                 const key = snapshot.key;

    //                 if (key !== 'name') {



    //                     //console.log(data); // A list of all the card names in the user's current deck

    //                     const cardStorageRef = ref_storage(storage, 'images/' + data);
    //                     getDownloadURL(cardStorageRef)
    //                     .then((url) => {

    //                         playingField.innerHTML += `
    //                             <div class="card-container">
    //                                 <div class="card">
                                    
    //                                     <!-- Front of the card content -->
    //                                     <img class="playing-card-image" src="` + url + `" alt="Card 1">
    //                                 </div>
    //                             </div>
    //                         `
    //                         ;

    //                     })
    //                     .catch((error) => {
    //                         console.log("Error: " + error);
    //                     });

    //                 }

    //             });






    //             // playingField.innerHTML += `
    //             // <div class="card-container">
    //             //             <div class="card">
                                
    //             //                     <!-- Front of the card content -->
    //             //                     <img class="playing-card-image" src="card_images/Blue Birdington.png" alt="Card 1">
                                
    //             //             </div>
    //             //         </div>
    //             //         <div class="card-container">
    //             //             <div class="card">
                            
    //             //                     <!-- Front of the card content -->
    //             //                     <img class="playing-card-image" src="card_images/Blue Birdington.png" alt="Card 2">
                                
    //             //             </div>
    //             //         </div>
    //             //         <div class="card-container">
    //             //             <div class="card">
                            
    //             //                     <!-- Front of the card content -->
    //             //                     <img class="playing-card-image" src="card_images/Blue Birdington.png" alt="Card 2">
                                
    //             //             </div>
    //             //         </div>
    //             // `;







    //             setTimeout(function() {
    //                 // MAKE THE CARDS DRAGGABLE 
    //                 // Add your Firebase configuration and database code here if needed

    //                 const cards = document.querySelectorAll('.card');
    //                 let draggedCard = null;
    //                 let offsetX, offsetY;
    //                 let isDragging = false;

    //                 cards.forEach((card, index) => {
    //                     // Position all the cards on top of each other within the playingField
    //                     card.style.right = '0';
    //                     card.style.bottom = `0`; // Add some spacing between the cards

    //                     card.addEventListener('mousedown', (event) => {

    //                         // Prevent the browser from dragging an image instead of the card
    //                         event.preventDefault();
    //                         // Start dragging the card when the mouse is pressed down on it
    //                         draggedCard = card;
    //                         card.style.opacity = '0.5'; // Make the card transparent while dragging

    //                         // Calculate the offset between the mouse cursor and the card's position
    //                         const rect = card.getBoundingClientRect();
    //                         offsetX = event.clientX - rect.left;
    //                         offsetY = event.clientY - rect.top;

    //                         isDragging = true;
    //                     });


                        
    //                 });

                    

    //                 document.addEventListener('mousemove', (event) => {
    //                     // Move the dragged card with the mouse cursor
    //                     if (isDragging) {
    //                         const fieldRect = playingField.getBoundingClientRect();
    //                         const cardLeft = event.clientX - fieldRect.left - offsetX;
    //                         const cardTop = event.clientY - fieldRect.top - offsetY;

    //                         draggedCard.style.position = 'absolute';
    //                         draggedCard.style.left = `${cardLeft}px`;
    //                         draggedCard.style.top = `${cardTop}px`;
    //                     }
    //                 });

    //                 document.addEventListener('mouseup', (event) => {
    //                     // Drop the card into the playing field when the mouse is released
    //                     if (draggedCard) {
    //                         console.log('test');
    //                         const playingField = document.getElementById('playingField');

    //                         // Calculate the card's position within the playingField container
    //                         const fieldRect = playingField.getBoundingClientRect();
    //                         const cardLeft = event.clientX - fieldRect.left - offsetX;
    //                         const cardTop = event.clientY - fieldRect.top - offsetY;

    //                         draggedCard.style.position = 'absolute';
    //                         draggedCard.style.left = `${cardLeft}px`;
    //                         draggedCard.style.top = `${cardTop}px`;
    //                         playingField.appendChild(draggedCard);

    //                         draggedCard.style.opacity = '1';
    //                         draggedCard = null;

    //                         isDragging = false;
                            
    //                     }

                        

    //                 });

    //             }, 1000); // 1 second delay to update the card physics after loading from Firebase




    //             gameMenuOverlay.style.display = 'none';


    //         });
            
    //         // Get a list of all existing games to show on the choose game overlay
    //         const gamesRef = ref_database(database, "Games/");
    //         onChildAdded(gamesRef, (snapshot) => {
    //             const gameData = snapshot.val();
    //             //console.log(gameData);
    //             const gameKey = snapshot.key;
    //             //console.log(gameKey);

    //             const gameListContainer = document.getElementById("existingGameSelectId");
    //             const newGameOption = document.createElement("option");
    //             newGameOption.setAttribute("value", gameKey);
    //             newGameOption.textContent = gameKey;

    //             // Add each game to the dropdown selection
    //             gameListContainer.appendChild(newGameOption);

    //         });


    //         // Join and become Player 2 in an existing game
    //         document.getElementById("joinGameButton").addEventListener("click", function(event) {

    //             const navHeader = document.getElementById("headerContainerId");
    //             navHeader.style.display = 'none';
    //             navHeader.style.visibility = 'hidden';


    //             const gameToJoin = document.getElementById("existingGameSelectId").value;

    //             // This will be the date/time and user that started the game, as the unique key for the game
    //             console.log(gameToJoin);

    //             // Using 'gameToJoin', access the database at that node, and using the game data, display the game state in battleground





    //             // 1. Update your side of the field with your deck and data


                


    //                 // UPDATE THE PLAYING FIELD

    //                 // Get a reference to each card that is in your Current Deck,
    //                 // Fill the playingField deck with cards that match your Deck

    //                 const playingField = document.getElementById("playingField");

    //                 const currentDeck = '34tr3ert34te'; // TEST DATA - Allow user to choose in the future
    //                 const userRef = ref_database(database, 'Users/' + auth.currentUser.uid + '/Decks/' + currentDeck);

    //                 onChildAdded(userRef, (snapshot) => {
    //                     const data = snapshot.val();
    //                     const key = snapshot.key;

    //                     if (key !== 'name') {



    //                         //console.log(data); // A list of all the card names in the user's current deck

    //                         const cardStorageRef = ref_storage(storage, 'images/' + data);
    //                         getDownloadURL(cardStorageRef)
    //                         .then((url) => {

    //                             playingField.innerHTML += `
    //                                 <div class="card-container">
    //                                     <div class="card">
                                        
    //                                         <!-- Front of the card content -->
    //                                         <img class="playing-card-image" src="` + url + `" alt="Card 1">
    //                                     </div>
    //                                 </div>
    //                             `
    //                             ;

    //                         })
    //                         .catch((error) => {
    //                             console.log("Error: " + error);
    //                         });

    //                     }

    //                 });






    //                 // playingField.innerHTML += `
    //                 // <div class="card-container">
    //                 //             <div class="card">
                                    
    //                 //                     <!-- Front of the card content -->
    //                 //                     <img class="playing-card-image" src="card_images/Blue Birdington.png" alt="Card 1">
                                    
    //                 //             </div>
    //                 //         </div>
    //                 //         <div class="card-container">
    //                 //             <div class="card">
                                
    //                 //                     <!-- Front of the card content -->
    //                 //                     <img class="playing-card-image" src="card_images/Blue Birdington.png" alt="Card 2">
                                    
    //                 //             </div>
    //                 //         </div>
    //                 //         <div class="card-container">
    //                 //             <div class="card">
                                
    //                 //                     <!-- Front of the card content -->
    //                 //                     <img class="playing-card-image" src="card_images/Blue Birdington.png" alt="Card 2">
                                    
    //                 //             </div>
    //                 //         </div>
    //                 // `;







    //                 setTimeout(function() {
    //                     // MAKE THE CARDS DRAGGABLE 
    //                     // Add your Firebase configuration and database code here if needed

    //                     const cards = document.querySelectorAll('.card');
    //                     let draggedCard = null;
    //                     let offsetX, offsetY;
    //                     let isDragging = false;

    //                     cards.forEach((card, index) => {
    //                         // Position all the cards on top of each other within the playingField
    //                         card.style.right = '0';
    //                         card.style.bottom = `0`; // Add some spacing between the cards

    //                         card.addEventListener('mousedown', (event) => {

    //                             // Prevent the browser from dragging an image instead of the card
    //                             event.preventDefault();
    //                             // Start dragging the card when the mouse is pressed down on it
    //                             draggedCard = card;
    //                             card.style.opacity = '0.5'; // Make the card transparent while dragging

    //                             // Calculate the offset between the mouse cursor and the card's position
    //                             const rect = card.getBoundingClientRect();
    //                             offsetX = event.clientX - rect.left;
    //                             offsetY = event.clientY - rect.top;

    //                             isDragging = true;
    //                         });


                            
    //                     });

                        

    //                     document.addEventListener('mousemove', (event) => {
    //                         // Move the dragged card with the mouse cursor
    //                         if (isDragging) {
    //                             const fieldRect = playingField.getBoundingClientRect();
    //                             const cardLeft = event.clientX - fieldRect.left - offsetX;
    //                             const cardTop = event.clientY - fieldRect.top - offsetY;

    //                             draggedCard.style.position = 'absolute';
    //                             draggedCard.style.left = `${cardLeft}px`;
    //                             draggedCard.style.top = `${cardTop}px`;
    //                         }
    //                     });

    //                     document.addEventListener('mouseup', (event) => {
    //                         // Drop the card into the playing field when the mouse is released
    //                         if (draggedCard) {
    //                             console.log('test');
    //                             const playingField = document.getElementById('playingField');

    //                             // Calculate the card's position within the playingField container
    //                             const fieldRect = playingField.getBoundingClientRect();
    //                             const cardLeft = event.clientX - fieldRect.left - offsetX;
    //                             const cardTop = event.clientY - fieldRect.top - offsetY;

    //                             draggedCard.style.position = 'absolute';
    //                             draggedCard.style.left = `${cardLeft}px`;
    //                             draggedCard.style.top = `${cardTop}px`;
    //                             playingField.appendChild(draggedCard);

    //                             draggedCard.style.opacity = '1';
    //                             draggedCard = null;

    //                             isDragging = false;
                                
    //                         }

                            

    //                     });

    //                 }, 1000); // 1 second delay to update the card physics after loading from Firebase




    //                 gameMenuOverlay.style.display = 'none';





    //             // 2. Update the opposing side of the field with player 1's deck and data


                










































    //         });

            






            
            


    //     }
        
    // });



































    // SUBMIT BUTTON ON FORM SENDS CARD TO DATABASE
    function submitForm() {

        const cardType = document.getElementById("cardTypeSelect").value;
        console.log(cardType);

        // Get the input values
        const cardName = document.getElementById("addCardNameId").value;
        const cardRules = document.getElementById("addCardRulesId").value;
        const cardTagInput = document.getElementById("tagInputId").value;
        const tagArray = String(cardTagInput).split(', ');


        if (cardType === 'bird')
        {
            const cardSubtype = document.getElementById("addSubtypeInputId").value;
            const cardPower = document.getElementById("addPowerInputId").value;

            const cardRedCost = document.getElementById("addRedCostInputId").value;
            const cardBlueCost = document.getElementById("addBlueCostInputId").value;
            const cardBlackCost = document.getElementById("addBlackCostInputId").value;


            const cardPicture = new Image();

            // Save image as new card image, then push that into storage
            saveImage().then((combinedImage) => {
                cardPicture.src = combinedImage;
                // Call your function and pass the input values
                saveBirdToDB(tagArray, cardName, cardType, cardRules, cardPicture, cardSubtype, cardRedCost, cardBlueCost, cardBlackCost, cardPower);
            });

        }
        else if (cardType === 'song')
        {
            console.log('Song is runnning');

            const reqEggs = document.getElementById("eggInputNumberId").value;
            const reqNest = document.getElementById("nestInputNumberId").value;
            const reqAir = document.getElementById("airInputNumberId").value;
            const reqGround = document.getElementById("groundInputNumberId").value;
            const cardPicture = new Image();

            // Save image as new card image, then push that into storage
            saveImage().then((combinedImage) => {
                cardPicture.src = combinedImage;


                // Call your function and pass the input values
                saveSongToDB(tagArray, cardName, cardType, cardRules, cardPicture, reqEggs, reqNest, reqAir, reqGround);
            });



        }
        else if (cardType === 'feather')
        {
            console.log('Feather is runnning');
            const cardPicture = new Image();

            // Save image as new card image, then push that into storage
            saveImage().then((combinedImage) => {
                cardPicture.src = combinedImage;


                // Call your function and pass the input values
                saveFeatherToDB(tagArray, cardName, cardType, cardRules, cardPicture);
            });

        }
        else if (cardType === 'egg')
        {
            console.log('Egg is runnning');
            const cardPicture = new Image();

            // Save image as new card image, then push that into storage
            saveImage().then((combinedImage) => {
                cardPicture.src = combinedImage;


                // Call your function and pass the input values
                saveEggToDB(tagArray, cardName, cardType, cardRules, cardPicture);
            });



        }
        

        // Prevent the form from submitting and refreshing the page
        return false;
    }

    function saveBirdToDB(tags, name, type, rules, picture, subtype, red, blue, black, power) {
        // Perform operations with the input values
        //console.log("Card Name: " + cardName);
        //console.log("Card Power: " + cardPower);
        // Add your logic here:
        const dataRef = ref_database(database, 'Cards/' + name);
        const storageRef = ref_storage(storage, 'images/' + name);
        imageAsBlob(picture.src).then(blob =>
        {
            uploadBytes(storageRef, blob).then( (snapshot) =>
            {
                console.log("uploaded a file");
                displayConfirmationMessage();
            });
            
         })
        const data = {
            name: name,
            tags: tags,
            type: type,
            rules: rules,
            //picture: picture.src,
            subtype: subtype,
            red: red,
            blue: blue,
            black: black,
            power: power
        }
        set(dataRef, data);
        //displayCards();
    }

    function saveSongToDB(tags, name, type, rules, picture, eggs, nest, air, ground) {
        // Perform operations with the input values
        //console.log("Card Name: " + cardName);
        //console.log("Card Power: " + cardPower);
        // Add your logic here:
        const dataRef = ref_database(database, 'Cards/' + name);
        const storageRef = ref_storage(storage, 'images/' + name);
        
        

        imageAsBlob(picture.src).then(blob =>
        {
            uploadBytes(storageRef, blob).then( (snapshot) =>
            {
                console.log("uploaded a file");
                displayConfirmationMessage();
            });
            
        })
        const data = {
            name: name,
            tags: tags,
            type: type,
            rules: rules,
            //picture: picture.src,
            reqEggs: eggs,
            reqNest: nest,
            reqAir: air,
            reqGround: ground,
        }
        set(dataRef, data);
        //displayCards();
    }

    function saveFeatherToDB(tags, name, type, rules, picture) {
        // Perform operations with the input values
        //console.log("Card Name: " + cardName);
        //console.log("Card Power: " + cardPower);
        // Add your logic here:
        const dataRef = ref_database(database, 'Cards/' + name);
        const storageRef = ref_storage(storage, 'images/' + name);
        imageAsBlob(picture.src).then(blob =>
        {
            uploadBytes(storageRef, blob).then( (snapshot) =>
            {
                console.log("uploaded a file");
                displayConfirmationMessage();
            });
            
        })
        const data = {
            name: name,
            tags: tags,
            type: type,
            rules: rules,
            //picture: picture.src,
        }
        set(dataRef, data);
        //displayCards();
    }

    function saveEggToDB(tags, name, type, rules, picture) {
        // Perform operations with the input values
        //console.log("Card Name: " + cardName);
        //console.log("Card Power: " + cardPower);
        // Add your logic here:
        const dataRef = ref_database(database, 'Cards/' + name);
        const storageRef = ref_storage(storage, 'images/' + name);
        imageAsBlob(picture.src).then(blob =>
        {
            uploadBytes(storageRef, blob).then( (snapshot) =>
            {
                console.log("uploaded a file");
                displayConfirmationMessage();
            });
            
        })
        const data = {
            name: name,
            tags: tags,
            type: type,
            rules: rules,
            //picture: picture.src,
        }
        set(dataRef, data);
        //displayCards();
    }

    // CONFIRMS WHEN YOU SAVE A CARD
    function displayConfirmationMessage () {

        const messageOverlay = document.getElementById("confirmationMessageOverlayId");

        messageOverlay.style.display = 'block';

        setTimeout(function() {
            messageOverlay.style.display = 'none';
        }, 2000); // Set the delay in ms
    }













    // SAVE THE CARD PREVIEW TO YOUR LOCAL DOWNLOADS
    // document.getElementById("saveImageButton").addEventListener("click", function() {
    //     saveImage().then((combinedImage) => {
    //         const link = document.createElement('a');
    //         link.href = combinedImage;
    //         link.download = addCardNameId.value + '.png';
    //         link.click();
    //     })
    // });

   




    // OPENS THE OVERLAY CARD PREVIEW ON HOME SCREEN
    function openCardDisplayHomeView(picture, cardName) {

        // Reset the card overlay
        viewCardOverlay.style.display = "block";

        viewCardOverlay.innerHTML = `
        
        
            <div class="overlay-content" id="viewOverlayContainerId">
                <div class="content-container" id="contentContainerId">
                    <div class="left-column" id="previewLeftColumn">
                        <div class = "view-card-inner-left-column" id="viewCardInnerLeftColumn">
                            <div class="new-image-container">
                                <img id = "newImagePreview" src="" alt="Card"/>
                            <!-- <div class="text-box-card-name">
                                <h2 id="newCardNameTitleTextId">Card Title</h2>
                            </div>
                            <div class="text-box-card-rules">
                                <p id="newCardRulesTextId">Card Rules</p> 
                            </div> -->
                            </div>
                        </div>
                    </div>
                    <div class="right-column" id="previewRightColumn">
                        <div class="dropdown">
                            <select id="editSelect">
                            <option value="view">View</option>
                            <option value="edit">Edit</option>
                            <option value="delete">Delete</option>
                            </select>
                        </div>
                        <div class="innerRightColumn" id="innerRightColumnId">

                            
                            

                            <h2>View Card</h2>
                            <div id="cardInformation">
                                <!-- Add fields for the cards to be populated here-->
                            </div>

                            <p id="overlayTypeTest">Type</p>

                            <p id="overlayCardTitleP">Type</p>

                            <button id="addPreviewButton">Add to Preview</button>

                            
                        </div>
                    </div>

                </div>
            </div>
    
        
        `;

        // Close the overlay if clicking away
        const viewOverlayContainer = document.getElementById("viewOverlayContainerId");
        
        viewOverlayContainer.addEventListener("click", function(event) {
            if (event.target === viewOverlayContainer) {
                viewCardOverlay.style.display = "none";
            }
        });


        const overlayImage = document.getElementById("newImagePreview");
        overlayImage.setAttribute('src', picture.src);

        const titleParagraph = document.getElementById("overlayCardTitleP");
        titleParagraph.textContent = cardName;


        // // Close the overlay if you click away 
        // viewOverlayContainer.addEventListener("click", function(event) {
        //     if (event.target === viewOverlayContainer) {
        //         viewCardOverlay.style.display = "none";
        //     }
        // });
        
        

        toggleEditCardInputs();

    }


    // OPENS THE OVERLAY CARD PREVIEW IN THE DECK BUILDER
    function openCardDisplayDeckView(picture, cardName, deckKey) {

        // Reset the card overlay
        viewCardOverlay.style.display = "block";

        viewCardOverlay.innerHTML = `
        
        <div class="overlay-content" id="viewOverlayContainerId">
                <div class="content-container" id="contentContainerId">
                    <div class="left-column" id="previewLeftColumn">
                        <div class = "view-card-inner-left-column" id="viewCardInnerLeftColumn">
                            <div class="new-image-container">
                                <img id = "newImagePreview" src="" alt="Card"/>
                            <!-- <div class="text-box-card-name">
                                <h2 id="newCardNameTitleTextId">Card Title</h2>
                            </div>
                            <div class="text-box-card-rules">
                                <p id="newCardRulesTextId">Card Rules</p> 
                            </div> -->
                            </div>
                        </div>
                    </div>
                    <div class="right-column" id="previewRightColumn">
                        
                        <div class="innerRightColumn" id="innerRightColumnId">

                            
                            

                            
                            <div id="cardInformation">
                                <!-- Add fields for the cards to be populated here-->
                            </div>

                            <button id="deleteCardFromDeckButton">Delete</button>

                            
                        </div>
                    </div>

                </div>
            </div>
        
        `;

        // Close the overlay when clicking off
        const viewOverlayContainer = document.getElementById("viewOverlayContainerId");
        
        viewOverlayContainer.addEventListener("click", function(event) {
            if (event.target === viewOverlayContainer) {
                viewCardOverlay.style.display = "none";
            }
        });


        const overlayImage = document.getElementById("newImagePreview");
        overlayImage.setAttribute('src', picture.src);

        
        // Make the delete button remove a card from the Deck and re-sort the rest
        document.getElementById("deleteCardFromDeckButton").addEventListener("click", function(event) {
            
            // 1. Find a card in the deck that has this card's name
            const currentDeck = deckKey; //Replace this with real current deck
            const dataRef = ref_database(database, 'Users/' + auth.currentUser.uid + '/Decks/' + currentDeck);



            let deckCount = 0; // Set a counter to use later when you reorganize the data
            onChildAdded(dataRef, (counterSnapshot) => {
                const key = counterSnapshot.key;
                if (key !== 'name') {
                    deckCount++;
                }
            });

            console.log("deckCount: " + deckCount);
            const constDeckCount = deckCount; // Immutable constDeckCount is equal to the number of cards BEFORE you delete a card



            let success = false;

            onChildAdded (dataRef, (snapshot) => {
                const cardData = snapshot.val(); // card name
                const cardKey = snapshot.key; // card index

                const keyValue = parseInt(cardKey, 10); // Use the index to set data recursively
                

                // Enter the resetting part of the function - success is true, we've found the card to be removed and we are now one past it
                if (success && cardKey !== 'name') {
                    const previousCardRef = ref_database(database, 'Users/' + auth.currentUser.uid + '/Decks/' + currentDeck + '/' + (keyValue - 1));
                    set (previousCardRef, cardData);
                }

                // 'success' handles cases where there are two cards and you only want to delete one
                if (cardData === cardName && !success) {
                    success = true;
        
                    // When you find one, stop deleting cards (exit the loop in case there are multiples of this card)
                    

                    //console.log(cardData + ', ' + cardName);

                    // 3. Remove the data at that position
                    // 3. NEW Reset each node, then remove the last node














                    // const cardRef = ref_database(database, 'Users/' + auth.currentUser.uid + '/Decks/' + currentDeck + '/' + cardKey);
                    // remove(cardRef)
                    //     .then(() => {
                    //         console.log('Deleted successfully!');



                    //         // 4. For each card that is still in the deck, get the value of each node (card title) and reset each key again from 1-20
                    //         // i.e. rewrite each Deck with new numbers each time it is changed
                    //         const deckRef = ref_database(database, 'Users/' + auth.currentUser.uid + '/Decks/' + currentDeck);
                    //         let numberCards = 1;

                    //         onChildAdded(deckRef, (newSnapshot) => {
                    //             const nameOfCard = newSnapshot.val();
                    //             const cardIndex = newSnapshot.key;

                                
                    //             console.log('Deck Count: ' + constDeckCount + ', Counter: ' + numberCards);

                    //             if (cardIndex !== 'name' && numberCards < constDeckCount - 1) {
                                    
                    //                 numberCards++;

                    //                 // Don't add the last card back to the deck
                                    
                                        

                    //                     // Create a reference at each new spot in the DB (starting at 1)
                    //                     const finalCardRef = ref_database(database, 'Users/' + auth.currentUser.uid + '/Decks/' + currentDeck + '/' + numberCards);
                    //                     console.log(numberCards + ': ' + cardIndex + ', ' + nameOfCard);
                    //                     set (finalCardRef, nameOfCard);

                                        

                    //                 // right now it is deleting a node, then taking the node that follows it and adding the followed node to the end of the list (20)
                    //             }


                    //         });


                    //     })
                    //     .catch((error) => {
                    //         console.error('Error deleting:', error);
                    //     });



                    
                }

                // If you've reached the last node, remove it
                if (keyValue === constDeckCount) {
                    const cardRemoveRef = ref_database(database, 'Users/' + auth.currentUser.uid + '/Decks/' + currentDeck + '/' + cardKey);
                    remove(cardRemoveRef)
                        .then(() => {
                                console.log('Deleted successfully!');
                        })
                        .catch((error) => {
                            console.log('Error deleting data');
                        });
                }


            });

            
                            
            

        });






        //toggleEditCardInputs();

    }

















    // Buttons
    const overlayButton = document.getElementById("overlayButton");
    const viewCardOverlay = document.getElementById("viewCardOverlayId");
    const viewOverlayContainer = document.getElementById("viewOverlayContainerId");
    const addOverlayContainer = document.getElementById("addOverlayContainerId");
    const contentOverlay = document.getElementById("contentContainerId");
    const lowerContentContainer = document.getElementById("lowerContentId");

    const closeButton = document.getElementById("closeButton");

    const option1Button = document.getElementById("option1Button");
    const option2Button = document.getElementById("option2Button");
    const overlayRulesText = document.getElementById("overlayRulesText");

    const hamburgerButton = document.getElementById('hamburgerButton');
    const hamburgerMenu = document.getElementById('hamburgerMenu');
    const showHamburgerButton = document.getElementById('showHamburgerButton');

    const accountButton = document.getElementById('accountButton');
    const addCardMenuButton = document.getElementById('addCardMenuButton');
    const addCardNavButton = document.getElementById('addCardNavButton');
    const addCardOverlay = document.getElementById('addCardOverlay');
    const closeOverlayButton = document.getElementById('closeOverlayButton');

    const editCardMenuButton = document.getElementById('editCardMenuButton');
    const deckBuildMenuButton = document.getElementById('deckBuildMenuButton');
    const battleMenuButton = document.getElementById('battleMenuButton');


    // Setting the listeners here
    addCardMenuButton.addEventListener('click', () => {
        if (isAdmin) {
            addCardOverlay.style.display = 'block';
            toggleCardInputs();
            hamburgerMenu.classList.toggle('open');
        }
    });

    addCardNavButton.addEventListener('click', () => {
        if (isAdmin) {
            addCardOverlay.style.display = 'block';
            toggleCardInputs();
        }
    });

    closeOverlayButton.addEventListener('click', () => {
        addCardOverlay.style.display = 'none';
    });

    //DISPLAY LOG IN PAGE
    accountButton.addEventListener('click', () => {
        const searchContainer = document.getElementById("searchBarContainer");
        searchContainer.style.display = "none";
        searchContainer.style.visibility = "hidden";

        hamburgerMenu.classList.toggle('open');

        lowerContentContainer.innerHTML = `
        <div class="account-page-container">
            <form id="createAccountForm">
                <label for="createEmail">Email:</label>
                <input type="email" id="createEmail" name="email" required>
                <br>
                <label for="createPassword">Password:</label>
                <input type="password" id="createPassword" name="password" required>
                <br>
                <label for="createPassword">Name:</label>
                <input type="text" id="createName" name="name" required>
                <br>
                <button type="submit">Create Account</button>
            </form>
            <form id="loginForm">
                <label for="loginEmail">Email:</label>
                <input type="email" id="loginEmail" name="email" required>
                <br>
                <label for="password">Password:</label>
                <input type="password" id="loginPassword" name="password" required>
                <br>
                <button type="submit">Log In</button>
            </form>
            <button id="signOutButtonId">Sign Out</button>
        </div>
        `;

          // LOG A USER IN WHEN THEY PRESS THE BUTTON
                // Get a reference to the login form
                const loginForm = document.getElementById("loginForm");

            // Handle form submission
                loginForm.addEventListener("submit", (event) => {
                event.preventDefault();

                // Get user input
                const email = loginForm.email.value;
                const password = loginForm.password.value;

                // Sign in with email and password using Firebase Authentication
                signInWithEmailAndPassword(auth, email, password)
                    .then((userCredential) => {
                        // User successfully logged in
                        const user = userCredential.user;
                        console.log("User logged in:", user);
                        // You can redirect to another page or handle the login state as needed
                    })
                    .catch((error) => {
                        // Handle login error
                        console.error("Login error:", error.message);
                    });
            });


            // SIGN A USER OUT WHEN THEY PRESS BUTTON
            document.getElementById("signOutButtonId").addEventListener("click", function() {
                
                signOut(auth).then(() => {
                    // Sign-out successful.
                }).catch((error) => {
                    // An error happened.
                });
            });

            // CREATE A NEW ACCOUNT
            // Get a reference to the create account form
            const createAccountForm = document.getElementById("createAccountForm");

            // Handle form submission
            createAccountForm.addEventListener("submit", (event) => {
                event.preventDefault();

                // Get user input
                const email = createAccountForm.email.value;
                const password = createAccountForm.password.value;
                const name = createAccountForm.name.value;

                // Create user account with email and password using Firebase Authentication
                createUserWithEmailAndPassword(auth, email, password)
                    .then((userCredential) => {
                        // User account successfully created
                        const user = userCredential.user;

                        // Add user to DB
                        const dataRef = ref_database(database, 'Users/' + user.uid);
                        const data = {
                            name: name,
                            admin: false
                        }
                        set (dataRef, data);

                        console.log("User account created");
                        // You can redirect to another page or handle the login state as needed


                    })
                    .catch((error) => {
                        // Handle account creation error
                        console.error("Account creation error:", error.message);
                    });
            });


    });
    
    viewOverlayContainer.addEventListener("click", function(event) {
        if (event.target === viewOverlayContainer) {
            viewCardOverlay.style.display = "none";
        }
    });

    addOverlayContainer.addEventListener("click", function(event) {
        if (event.target === addOverlayContainer) {
            addCardOverlay.style.display = "none";
        }
    });

    

    showHamburgerButton.addEventListener('click', () => {
        hamburgerMenu.classList.toggle('open');
    });


    // Testing card queue overlay
    const queueOverlay = document.getElementById('queueOverlayId');
    const queueHamburgerButton = document.getElementById('queueHamburgerButton');

    queueHamburgerButton.addEventListener('click', function() {
        queueOverlay.classList.toggle('hide-overlay');
    });






    // Sets a listener on the tag update button when adding a card
    // SHOULD BE FIXED LATER TO ALLOW YOU TO ADD AND REMOVE TAGS 
    tagUpdate();
    function tagUpdate() {
        // document.getElementById("addTagButton").addEventListener("click", function(event) {
        //             //event.preventDefault(); // Prevent form submission and page reload
        //             const input = document.getElementById("tagInputId");
        //             const paragraph = document.getElementById("tagListP");
        //             const newText = input.value;
        //             paragraph.innerHTML += newText;
                    

        //             //const cardTagInput = document.getElementById("tagInputId").value;
        //         const tagArray = String(newText).split(', ');
        //         console.log(tagArray);
        //             input.value = "";
        //         });
    }





    // Utility to upload image to storage as a blob
    function imageAsBlob(imageURL){
        return fetch(imageURL).then(response => response.blob());
    }




    // Utility to save an image over another image
    function saveImage() {
    return new Promise((resolve) => {
        // Create a new canvas element
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');

        const cardTypeSelect = document.getElementById('cardTypeSelect').value;

        const baseImage = new Image();
        
        if (cardTypeSelect === 'song') {
            baseImage.src = '/card_images/Song Template.png';
        }
        else if (cardTypeSelect === 'feather') {
            baseImage.src = '/card_images/Feather Egg Template.png';
        }
        else if (cardTypeSelect === 'egg') {
            baseImage.src = '/card_images/Feather Egg Template.png';
        }
        else {
        // Load the base blank image
            baseImage.src = '/card_images/Bird Template.png'; // Replace with the actual path to the base image
        }

        // Load the artwork image
        const secondImage = new Image();
        secondImage.src = addImagePreview.src; // Replace with the actual path to the  image

        // Wait for both images to load
        Promise.all([loadImage(baseImage)]).then(() => {
        // Set canvas size to match the base image dimensions
        canvas.width = baseImage.width;
        canvas.height = baseImage.height;

        // Draw the base image onto the canvas
        context.drawImage(baseImage, 0, 0);

        // Add card title text to the canvas
        const cardNameText = document.getElementById('addCardNameId');
        const text = cardNameText.value; // Replace with your desired text
        context.font = 'bold 42px Times New Roman';
        context.fillStyle = 'black';
        context.textAlign = 'center';


        // REsize title text for long names
        if(cardTypeSelect === 'bird'){
            if (text.length > 19)
            {
                context.font = 'bold 24px Times New Roman';
                console.log(context.font);
                context.fillText(text, canvas.width / 2, 95); // Adjust the y-coordinate to position the text vertically
            }
            else {
                context.fillText(text, canvas.width / 2, 95); // Adjust the y-coordinate to position the text vertically
            }
        }
        else {
            context.fillText(text, canvas.width / 2, 95); // Adjust the y-coordinate to position the text vertically
        }
       

        

        // Add special Bird parts of the card
        if (cardTypeSelect === 'bird'){

            // Add card faction color to the canvas
            const factionSelect = document.getElementById('addFactionSelectId').value;
            const factionImage = new Image();
            if (factionSelect === 'red') {
                factionImage.src = 'card_images/redFactionPip.png';
                context.drawImage(factionImage, 28, 42);
            }
            else if (factionSelect === 'blue') {
                factionImage.src = 'card_images/blueFactionPip.png';
                context.drawImage(factionImage, 28, 42);
            }
            else if (factionSelect === 'black') {
                factionImage.src = 'card_images/blackFactionPip.png';
                context.drawImage(factionImage, 28, 42);
            }
            else {
                context.fillStyle = 'black';
            }


            // Add card power text to the canvas
            const cardPowerText = document.getElementById('addPowerInputId');
            const powerText = cardPowerText.value; // Replace with your desired text
            context.font = 'bold 80px Times New Roman';
            if (factionSelect === '') {
                context.fillStyle = 'black';
            }
            else {
                context.fillStyle = 'white';
            }
            context.textAlign = 'center';
            context.fillText(powerText, 100, 140); // Adjust the y-coordinate to position the text vertically


            // Add card color cost to the canvas
            const redCount = document.getElementById('addRedCostInputId').value;
            const blueCount = document.getElementById('addBlueCostInputId').value;
            const blackCount = document.getElementById('addBlackCostInputId').value;

            console.log(redCount, ", ", blueCount, ", ", blackCount);

            const boundaryX = 590; // X-coordinate of the top-left corner of the box
            const boundaryY = 70; // Y-coordinate of the top-left corner of the box
            const boundaryWidth = 200; // Width of the box
            const boundaryHeight = 150; // Height of the box

            const redPipImage = '/card_images/redPip.png';
            const bluePipImage = '/card_images/bluePip.png';
            const blackPipImage = '/card_images/blackPip.png';
            const imageArray = [];

            for (let i = 0; i < redCount; i++) {
                const redImage = new Image();
                redImage.src = redPipImage;
                imageArray.push(redImage);
            }
            for (let i = 0; i < blueCount; i++) {
                const blueImage = new Image();
                blueImage.src = bluePipImage;
                imageArray.push(blueImage);
            }
            for (let i = 0; i < blackCount; i++) {
                const blackImage = new Image();
                blackImage.src = blackPipImage;
                imageArray.push(blackImage);
            }

            
            for (let i = 0; i < imageArray.length; i++) {
                const x = boundaryX + (i % imageArray.length) * 25; // Adjust the positioning of the images within the box
                const y = boundaryY + Math.floor(i / imageArray.length) * 50; // Adjust the positioning of the images within the box

                context.drawImage(imageArray[i], x, y, 20, 20); // Draw the image at the specified coords
            }

        }



        // Add card type text to the canvas
        const cardTypeText = document.getElementById('addCardTypeTextId');
        const typeText = cardTypeText.textContent; // Replace with your desired text
        context.font = 'bold 32px Times New Roman';
        context.fillStyle = 'black';
        context.textAlign = 'center';
        context.fillText(typeText, canvas.width / 2, 660); // Adjust the y-coordinate to position the text vertically



        if (cardTypeSelect === 'song'){
            // Add card requirement to the canvas
            const eggReq = document.getElementById('eggInputNumberId');
            let eggText = "";
            if (eggReq.value > 0){
                eggText = "Egg: " + eggReq.value; // Replace with your desired text
            }

            
            const nestReq = document.getElementById('nestInputNumberId');
            let nestText = "";
            if (nestReq.value > 0){
                nestText = " Nest: " + nestReq.value; // Replace with your desired text
            }

            const airReq = document.getElementById('airInputNumberId');
            let airText = "";
            if (airReq.value > 0){
                airText = " Air: " + airReq.value; // Replace with your desired text
            }
            

            const groundReq = document.getElementById('groundInputNumberId');
            let groundText = "";
            if (groundReq.value > 0){
                groundText = " Ground: " + groundReq.value; // Replace with your desired text
            }

            const fullReqText = eggText + nestText + airText + groundText;

            context.font = 'bold 24px Times New Roman';
            context.fillStyle = 'black';
            context.textAlign = 'center';
            context.fillText(fullReqText, canvas.width / 2, 750); // Adjust the y-coordinate to position the text vertically
        }


        // Add bottom text (card rules) to the canvas (ADD DIFFERENT SIZE FOR SONGS)
            const cardRulesText = document.getElementById('addCardRulesId');
            const bottomText = cardRulesText.value; // Replace with your desired bottom text


            
            let textBoxWidth = 600; // Replace with the desired width of the text box
            let textBoxHeight = 300; // Replace with the desired height of the text box
            const textBoxX = (canvas.width - textBoxWidth) / 2; // Center horizontally
            let textBoxY = (canvas.height - textBoxHeight) + 50; // Center v. Adjust the y-coordinate to position the text box vertically

            if (cardTypeSelect === 'song'){
                 textBoxWidth = 590;
                 textBoxHeight = 200;
                 textBoxY = canvas.height - 240; // Adjust the y-coordinate to position the text box vertically
             }


            context.save();
            context.beginPath();
            context.rect(textBoxX, textBoxY, textBoxWidth, textBoxHeight);
            context.clip();


            

            const lineHeight = 30; // Adjust the line height for each wrapped line
            const maxLines = Math.floor(textBoxHeight / lineHeight); // Maximum number of lines that can fit in the box
        

            const words = bottomText.split(' ');
            let line = '';
            let wrappedText = '';
            let lineCount = 0;


            for (let i = 0; i < words.length; i++) {
                
                const testLine = line + words[i] + ' ';
                const metrics = context.measureText(testLine);
                const testWidth = metrics.width;
                

                if (testWidth > textBoxWidth && i > 0) {
                    if (lineCount < maxLines - 1) {
                        wrappedText += line.trim() + '\n';
                        line = words[i] + ' ';
                        lineCount++;
                    } else {
                        wrappedText += '...';
                        break;
                    }
                } else {
                    line = testLine;
                }
            }
            

            
            wrappedText += line.trim();
            const lines = wrappedText.split('\n');
            
            context.font = '38px Times New Roman';

            for (let i = 0; i < lines.length; i++) {
                const textX = textBoxX + textBoxWidth / 2; // x-coordinate remains the same for each line
                const textLineY = (textBoxY + lineHeight) + i * lineHeight; // y-coordinate for each line

                context.fillText(lines[i], textX, textLineY, textBoxWidth);
            }

            //context.fillText(wrappedText, textBoxX + textBoxWidth / 2, textBoxY + lineHeight, textBoxWidth); // Adjust the y-coordinate to position the bottom text

            context.restore();




        // Define the position and size of the second image
        const boxWidth = 400; // Replace with the desired width of the box
        const boxHeight = 400; // Replace with the desired height of the box
        const x = (canvas.width - boxWidth) / 2; // Center horizontally
        const y = 180; // Adjust the y-coordinate to move the image down

        // Draw the second image onto the canvas, fitting it within the box
        context.drawImage(secondImage, x, y, boxWidth, boxHeight);

        // Save the combined image
        const combinedImage = canvas.toDataURL();

        resolve(combinedImage);
        });
    });
    }

    function loadImage(image) {
    return new Promise((resolve) => {
        image.onload = resolve;
    });
    }


  




    // This is a utility that updates the card preview inside the Add a Card overlay
    updateCardImagePreview();
    
    function updateCardImagePreview() {
        document.getElementById("imageInput").addEventListener("change", (event) => {
            const imagePreview = document.getElementById("addImagePreview");
            const file = event.target.files[0];

            if (file) {
                const reader = new FileReader();

                reader.onload = (e) => {
                const imageDataURL = e.target.result;
                // Use the imageDataURL as needed (e.g., display or upload the image)
                // console.log(imageDataURL);
                imagePreview.src = imageDataURL;

                };

                reader.readAsDataURL(file);
            }
        });



    }


















    // This changes the Add a Card overlay based on the input selected from dropdown
    document.getElementById("cardTypeSelect").addEventListener("change", function() {
        const cardSelect = document.getElementById("cardTypeSelect").value;
        console.log(cardSelect);
        toggleCardInputs();
    });

    function toggleCardInputs() {
        
        // const parentLeftColumn = document.getElementById("leftColumn");
        // parentLeftColumn.innerHTML = `
        //     <div class="add-card-inner-left-column" id="addCardInnerLeftColumn">
                
        //     </div>
        // `;

        const leftColumn = document.getElementById("addCardInnerLeftColumn");
        const rightColumn = document.getElementById("rightColumn");

        
        // Reset inputs to default state
        // leftColumn.innerHTML = `
        //     <div class="dropdown-container">
        //                     <h2>Add</h2>
        //                     <select class="add-dropdown-select" id="cardTypeSelect">
        //                     <option value="bird">Bird</option>
        //                     <option value="song">Song</option>
        //                     <option value="feather">Feather</option>
        //                     <option value="egg">Egg</option>
        //                     </select>
        //                     <h2>Card</h2>
        //     </div>
        // `;


        const cardTypeSelect = document.getElementById("cardTypeSelect");       
        const selectedOption = cardTypeSelect.value;

        

        // Handle different options

        

        if (selectedOption === "bird") {

            // Custom inputs for type 1
             leftColumn.innerHTML = `
             
                <div class="dropdown-container">
                        <h2>Add</h2>
                        <select class="add-dropdown-select" id="cardTypeSelect">
                          <option value="bird">Bird</option>
                          <option value="song">Song</option>
                          <option value="feather">Feather</option>
                          <option value="egg">Egg</option>
                        </select>
                        <h2>Card</h2>
                </div>
                


                <form action="" id="inputForm">


                    <div class="add-card-first-row">
                        <div class="power-faction-container">
                            <div class="power-container">
                                        <label for="addPowerInputId">Power:</label>
                                        <input type="number" id="addPowerInputId" name="powerInput" value="0">
                            </div>

                            <div class="faction-container">
                                    <label for="addFactionInputId">Faction:</label>
                                    <select id="addFactionSelectId">
                                            <option value=""></option>
                                            <option value="red">Red</option>
                                            <option value="blue">Blue</option>
                                            <option value="black">Black</option>
                                    </select>
                            </div>
                        </div>

                        <div class="name-container">
                            <input type="text" placeholder="Name" id="addCardNameId" name="cardName" required>
                        </div>
                        
                    </div>
                    

                    <div class="add-card-second-row">
                        <div class="color-cost-input-container">
                                <div>
                                    <label for="addRedCostInputId">Red:</label>
                                    <input type="number" id="addRedCostInputId" name="redCostInput" value="0">
                                </div>
                                <div>
                                    <label for="addBlueCostInputId">Blue:</label>
                                    <input type="number" id="addBlueCostInputId" name="blueCostInput" value="0">
                                </div>
                                <div>
                                    <label for="addBlackCostInputId">Black:</label>
                                    <input type="number" id="addBlackCostInputId" name="blackCostInput" value="0">
                                </div>
                        </div>
                    </div>


                    


                    <div class="add-card-third-row">
                        <input type="file" id="imageInput" name="cardImage" accept="image/*" required>
                    </div>




                    <div class="add-card-fourth-row">
                        <div class="subtype-container">
                            <input type="text" placeholder="Subtype" id="addSubtypeInputId" name="subtypeInput">
                        </div>
                    </div>





                    <div class="add-card-fifth-row">
                        <textarea id="addCardRulesId" placeholder="Card Rules" rows="4" cols="50"></textarea>
                    </div>
                    

                        
                    <div class="add-card-sixth-row">
                        <input type="text" placeholder="Tags," id="tagInputId" name="tagInput">
                    </div>

                    <div class="add-card-eighth-row">
                        <button type="submit" form="inputForm">Add to DB</button>
                    </div>
                


                </form>

                <div class="add-card-seventh-row">
                        <div class="add-card-add-note-container">
                            <button id="createNoteFromBird">Create New Note</button>
                        </div>
                        <div class="add-card-save-image-container">
                            <button id="saveImageButton">Save Image</button>
                        </div>                        
                </div>
                

                <div class="confirmation-message-overlay" id="confirmationMessageOverlayId">
                        <div class="confirmation-message-container">
                        <div id="confirmationMessage">Nice, you made a bird</div>
                        </div>
                </div>
            


             

         `;
        



             rightColumn.innerHTML = `
             <div class="add-image-container">
                <img id="addImageBackground" src="card_images/Bird Template.png" alt="">
                <img id="addImagePreview" src="card_images/favicon.png" alt="Card"/>

                <div class="text-box-card-power">
                    <h2 id="addCardPowerTextId">0</h2>
                </div>

                <div class="faction-img-container" id="factionContainerId">
                    <div class="img-box-card-faction" id="imgBoxCardFactionId"></div>
                </div>

                <div class="pips-container" id="pipsContainerId">
                    <div class="img-box-card-red" id="imgBoxCardRedId"></div>
                    <div class="img-box-card-blue" id="imgBoxCardBlueId"></div>
                    <div class="img-box-card-black" id="imgBoxCardBlackId"></div>
                </div>



                <div class="text-box-card-name">
                    <h2 id="addCardNameTitleTextId"></h2>
                </div>
                <div class="text-box-card-type">
                    <p id="addCardTypeTextId">Bird</p>
                </div>
                <div class="text-box-card-rules">
                    <p id="addCardRulesTextId"></p>
                </div>
             </div>
            `;




            // ADD THE LISTENERS BACK TO BIRD_SPECIFIC ATTRIBUTES

            const cardSubtypeText = document.getElementById('addCardTypeTextId');
            document.getElementById('addSubtypeInputId').addEventListener('input', function(event) {
                const enteredText = event.target.value;
                if (enteredText === ''){
                    cardSubtypeText.textContent = 'Bird';
                }
                else{
                    cardSubtypeText.textContent = 'Bird - ' + enteredText;
                }
            });

            const cardPowerText = document.getElementById('addCardPowerTextId');
            document.getElementById('addPowerInputId').addEventListener('input', function(event) {
                const enteredText = event.target.value;
                cardPowerText.textContent = enteredText;
            });

            // Listener for the faction color
            const cardFactionColor = document.getElementById('imgBoxCardFactionId');
            document.getElementById('addFactionSelectId').addEventListener('input', function(event) {
                const faction = event.target.value;

                if (faction === 'red') {
                    cardFactionColor.innerHTML = ``;
                    cardFactionColor.innerHTML += `
                        <img id="factionColorId" src="card_images/redFactionPip.png">
                    `;
                }
                else if (faction === 'blue') {
                    cardFactionColor.innerHTML = ``;
                    cardFactionColor.innerHTML += `
                        <img id="factionColorId" src="card_images/blueFactionPip.png">
                    `;
                }
                else if (faction === 'black') {
                    cardFactionColor.innerHTML = ``;
                    cardFactionColor.innerHTML += `
                        <img id="factionColorId" src="card_images/blackFactionPip.png">
                    `;
                }
                else {
                    cardFactionColor.innerHTML = ``;
                }
            });

            // Set up listeners on the color pips
            const cardRedCostPips = document.getElementById('imgBoxCardRedId');
            document.getElementById('addRedCostInputId').addEventListener('input', function(event) {
                const pipNumber = event.target.value;
                cardRedCostPips.innerHTML = ``;

                for (let i = 0; i < pipNumber; i++) {
                    cardRedCostPips.innerHTML += `
                        <img id="addCardRedImageId" src="card_images/redPip.png">
                    `;
                }
                
            });

            const cardBlueCostPips = document.getElementById('imgBoxCardBlueId');
            document.getElementById('addBlueCostInputId').addEventListener('input', function(event) {
                const pipNumber = event.target.value;
                cardBlueCostPips.innerHTML = ``;

                for (let i = 0; i < pipNumber; i++) {
                    cardBlueCostPips.innerHTML += `
                        <img id="addCardBlueImageId" src="card_images/bluePip.png">
                    `;
                }

            });

            const cardBlackCostPips = document.getElementById('imgBoxCardBlackId');
            document.getElementById('addBlackCostInputId').addEventListener('input', function(event) {
                const pipNumber = event.target.value;
                cardBlackCostPips.innerHTML = ``;

                for (let i = 0; i < pipNumber; i++) {
                    cardBlackCostPips.innerHTML += `
                        <img id="addCardBlackImageId" src="card_images/blackPip.png">
                    `;
                }

            });







        } else if (selectedOption === "song") {
            // Custom inputs for type 2
            leftColumn.innerHTML = `
            <div class="dropdown-container">
                        <h2>Add</h2>
                        <select class="add-dropdown-select" id="cardTypeSelect">
                          <option value="song">Song</option>
                          <option value="feather">Feather</option>
                          <option value="egg">Egg</option>
                          <option value="bird">Bird</option>
                        </select>
                        <h2>Card</h2>
            </div>

            <form action="" id="inputForm">
                <div class="add-card-first-row">
                    <input type="text" placeholder="Name" id="addCardNameId" name="cardName" required>
                </div>

                <div class="add-card-third-row">
                    <label for="imageInput">Card Image:</label>
                    <input type="file" id="imageInput" name="cardImage" accept="image/*" required>
                </div>

                

                
                <div class="song-requirement-input-container">
                    <label for="eggInputNumberId">Eggs:</label>
                    <input type="number" id="eggInputNumberId" name="eggInputNumber" value="0">
                    <label for="nestInputNumberId">Nest:</label>
                    <input type="number" id="nestInputNumberId" name="nestInputNumber" value="0">
                    <label for="airInputNumberId">Air:</label>
                    <input type="number" id="airInputNumberId" name="airInputNumber" value="0">
                    <label for="groundInputNumberId">Ground:</label>
                    <input type="number" id="groundInputNumberId" name="groundInputNumber" value="0">
                </div>

                <div class="add-card-fifth-row">
                    <textarea id="addCardRulesId" placeholder="Card Rules" rows="4" cols="50"></textarea>
                </div>
                
                <div class="add-card-sixth-row">
                    <input type="text" placeholder="Tags," id="tagInputId" name="tagInput">
                </div>



                <div class="add-card-eighth-row">
                        <button type="submit" form="inputForm">Add to DB</button>
                </div>
                

                </form>



                <div class="add-card-seventh-row">
                        <div class="add-card-add-note-container">
                            <button id="createNoteFromBird">Create New Note</button>
                        </div>
                        <div class="add-card-save-image-container">
                            <button id="saveImageButton">Save Image</button>
                        </div>                        
                </div>


            <div class="confirmation-message-overlay" id="confirmationMessageOverlayId">
                    <div class="confirmation-message-container">
                      <div id="confirmationMessage">Cool Song!</div>
                    </div>
            </div>
            `;

            rightColumn.innerHTML = `
            <div class="add-image-container">
                <img id="addImageBackground" src="card_images/Song Template.png" alt="">
                <img id="addImagePreview" src="card_images/songIcon.png" alt="Card"/>
                <div class="text-box-card-name">
                    <h2 id="addCardNameTitleTextId"></h2>
                </div>
                <div class="text-box-card-type">
                    <p id="addCardTypeTextId">Song</p>
                </div>
                <div class = "text-box-card-req">
                    <div class="egg-req">
                        <p id="addEggReqId"></p>
                    </div><div class="nest-req">
                        <p id="addNestReqId"></p>
                    </div><div class="air-req">
                        <p id="addAirReqId"></p>
                    </div><div class="ground-req">
                        <p id="addGroundReqId"></p>
                    </div>
                </div>
                <div class="text-box-card-rules-song">
                    <p id="addCardRulesTextId"></p>
                </div>
             </div>
            `;

            // Custom preview for type 2
            // rightColumn.innerHTML += `
            // <div class="type2-preview">
            //     <!-- Custom preview content for type 2 -->
            // </div>
            // `;

            // Reset listeners on the Requirements for Songs
            const eggReq = document.getElementById('addEggReqId');
            document.getElementById('eggInputNumberId').addEventListener('input', function(event) {

                const enteredText = event.target.value;
                if (enteredText === '0'){
                    eggReq.textContent = '';
                }
                else{
                    const newEnteredText = "Eggs: " + enteredText + "  ";
                    eggReq.textContent = newEnteredText;
                }
            });

            const nestReq = document.getElementById('addNestReqId');
            document.getElementById('nestInputNumberId').addEventListener('input', function(event) {

                const enteredText = event.target.value;
                if (enteredText === '0'){
                    nestReq.textContent = '';
                }
                else{
                    const newEnteredText = "Nest: " + enteredText + "  ";
                    nestReq.textContent = newEnteredText;
                }
            });

            const airReq = document.getElementById('addAirReqId');
            document.getElementById('airInputNumberId').addEventListener('input', function(event) {

                const enteredText = event.target.value;
                if (enteredText === '0'){
                    airReq.textContent = '';
                }
                else{
                    const newEnteredText = "Air: " + enteredText + "  ";
                    airReq.textContent = newEnteredText;
                }
            });

            const groundReq = document.getElementById('addGroundReqId');
            document.getElementById('groundInputNumberId').addEventListener('input', function(event) {

                const enteredText = event.target.value;
                if (enteredText === '0'){
                    groundReq.textContent = '';
                }
                else{
                    const newEnteredText = "Ground: " + enteredText + "  ";
                    groundReq.textContent = newEnteredText;
                }
            });


        } else if (selectedOption === "feather") {
            // Custom inputs for type 3
            leftColumn.innerHTML = `
            <div class="dropdown-container">
                        <h2>Add</h2>
                        <select class="add-dropdown-select" id="cardTypeSelect">
                          <option value="feather">Feather</option>
                          <option value="egg">Egg</option>
                          <option value="bird">Bird</option>
                          <option value="song">Song</option>
                        </select>
                        <h2>Card</h2>
            </div>

            <form action="" id="inputForm">
                <div class="add-card-first-row">
                    <input type="text" placeholder="Name" id="addCardNameId" name="cardName" required>
                </div>

                <div class="add-card-third-row">
                    <label for="imageInput">Card Image:</label>
                    <input type="file" id="imageInput" name="cardImage" accept="image/*" required>
                </div>

                

        

                <div class="add-card-fifth-row">
                    <textarea id="addCardRulesId" placeholder="Card Rules" rows="4" cols="50"></textarea>
                </div>
                
                <div class="add-card-sixth-row">
                    <input type="text" placeholder="Tags," id="tagInputId" name="tagInput">
                </div>



                <div class="add-card-eighth-row">
                        <button type="submit" form="inputForm">Add to DB</button>
                </div>
                

                </form>



                <div class="add-card-seventh-row">
                        <div class="add-card-add-note-container">
                            <button id="createNoteFromBird">Create New Note</button>
                        </div>
                        <div class="add-card-save-image-container">
                            <button id="saveImageButton">Save Image</button>
                        </div>                        
                </div>


            <div class="confirmation-message-overlay" id="confirmationMessageOverlayId">
                    <div class="confirmation-message-container">
                      <div id="confirmationMessage">Another feather in your cap</div>
                    </div>
            </div>
            `;

            rightColumn.innerHTML = `
            <div class="add-image-container">
                <img id="addImageBackground" src="card_images/Feather Egg Template.png" alt="">
                <img id="addImagePreview" src="card_images/featherIcon.png" alt="Card"/>
                <div class="text-box-card-name">
                    <h2 id="addCardNameTitleTextId"></h2>
                </div>
                <div class="text-box-card-type">
                    <p id="addCardTypeTextId">Feather</p>
                </div>
                <div class="text-box-card-rules">
                    <p id="addCardRulesTextId"></p>
                </div>
             </div>
            `;

            // Custom preview for type 3
            // rightColumn.innerHTML += `
            // <div class="type3-preview">
            //     <!-- Custom preview content for type 3 -->
            // </div>
            // `;
        }
        else if (selectedOption === "egg") {
            // Custom inputs for type 3
            leftColumn.innerHTML = `
            <div class="dropdown-container">
                        <h2>Add</h2>
                        <select class="add-dropdown-select" id="cardTypeSelect">
                          <option value="egg">Egg</option>
                          <option value="bird">Bird</option>
                          <option value="song">Song</option>
                          <option value="feather">Feather</option>
                        </select>
                        <h2>Card</h2>
            </div>

            <form action="" id="inputForm">
                <div class="add-card-first-row">
                    <input type="text" placeholder="Name" id="addCardNameId" name="cardName" required>
                </div>

                <div class="add-card-third-row">
                    <label for="imageInput">Card Image:</label>
                    <input type="file" id="imageInput" name="cardImage" accept="image/*" required>
                </div>

                

        

                <div class="add-card-fifth-row">
                    <textarea id="addCardRulesId" placeholder="Card Rules" rows="4" cols="50"></textarea>
                </div>
                
                <div class="add-card-sixth-row">
                    <input type="text" placeholder="Tags," id="tagInputId" name="tagInput">
                </div>



                <div class="add-card-eighth-row">
                        <button type="submit" form="inputForm">Add to DB</button>
                </div>
                

                </form>



                <div class="add-card-seventh-row">
                        <div class="add-card-add-note-container">
                            <button id="createNoteFromBird">Create New Note</button>
                        </div>
                        <div class="add-card-save-image-container">
                            <button id="saveImageButton">Save Image</button>
                        </div>                        
                </div>



            <div class="confirmation-message-overlay" id="confirmationMessageOverlayId">
                    <div class="confirmation-message-container">
                      <div id="confirmationMessage">egg</div>
                    </div>
            </div>
            `;

            rightColumn.innerHTML = `
            <div class="add-image-container">
                <img id="addImageBackground" src="card_images/Feather Egg Template.png" alt="">
                <img id="addImagePreview" src="card_images/eggIcon.png" alt="Card"/>
                <div class="text-box-card-name">
                    <h2 id="addCardNameTitleTextId"></h2>
                </div>
                <div class="text-box-card-type">
                    <p id="addCardTypeTextId">Egg</p>
                </div>
                <div class="text-box-card-rules">
                    <p id="addCardRulesTextId"></p>
                </div>
             </div>
            `;

            // Custom preview for type 3
            // rightColumn.innerHTML += `
            // <div class="type3-preview">
            //     <!-- Custom preview content for type 3 -->
            // </div>
            // `;
        }




            // Since there is new HTML being written here, new listeners need to attach to the card preview image/text
            updateCardImagePreview();

            const cardNameTitleText = document.getElementById('addCardNameTitleTextId');
            document.getElementById('addCardNameId').addEventListener('input', function(event) {
                const enteredText = event.target.value;
                cardNameTitleText.textContent = enteredText;
            });

            const cardRulesText = document.getElementById('addCardRulesTextId');
            document.getElementById('addCardRulesId').addEventListener('input', function(event) {
                const enteredText = event.target.value;
                cardRulesText.textContent = enteredText;
            });

            // Add the listener to the submit button again
            document.getElementById("inputForm").addEventListener("submit", function(event) {
                event.preventDefault(); // Prevent form submission and page reload
                submitForm();
            });

            // Add the listener to the add tag button again
            //tagUpdate();

            // Add listener to the Save Image button again
            document.getElementById("saveImageButton").addEventListener("click", function() {
                saveImage().then((combinedImage) => {
                    const link = document.createElement('a');
                    link.href = combinedImage;
                    link.download = addCardNameId.value + '.png';
                    link.click();
                })
            });

            // Add listener for the dropdown again
            document.getElementById("cardTypeSelect").addEventListener("change", function() {
                console.log('test');
                toggleCardInputs();

            });

            // Add listener to the Create New Note button
            document.getElementById("createNoteFromBird").addEventListener("click", function(event) {
               
                const noteConfirmP = document.getElementById("noteConfirmParagraphId");

                if (cardNameTitleText.textContent !== '') {

                    const theDate = new Date();
                    const newNoteId = theDate + " - " + cardNameTitleText.textContent;

                    // Create a new note with the card title as it's title
                    const dataRef = ref_database(database, 'Notes/' + newNoteId);
                    
                    const stringTime = "" + theDate;
                    const data = {
                        title: cardNameTitleText.textContent,
                        content: 'Notes for ' + cardNameTitleText.textContent,
                        user: 'Testuser',   // user that first created note
                        created: stringTime // date created
                    }
                    set (dataRef, data);


                    
                    noteConfirmP.textContent = "Note created";

                    setTimeout(function() {
                        noteConfirmP.textContent = '';
                    }, 2000);

                    
                }
                else {
                    noteConfirmP.textContent = "Note still needs a title";

                    setTimeout(function() {
                        noteConfirmP.textContent = '';
                    }, 2000);
                }


            });
            

            
    }






    
    // This changes the Edit Card overlay based on the input selected from dropdown
    document.getElementById("editSelect").addEventListener("change", function() {
        //const cardSelect = document.getElementById("cardTypeSelect").value;
        toggleEditCardInputs();
    });

    function toggleEditCardInputs() {
        const editSelect = document.getElementById("editSelect");
        const leftColumn = document.getElementById("viewCardInnerLeftColumn");
        const rightColumn = document.getElementById("innerRightColumnId");

        const cardTitle = document.getElementById("overlayCardTitleP");
        const cardTitleText = cardTitle.textContent;

        const selectedOption = editSelect.value;

        // Reset inputs to default state
        // leftColumn.innerHTML = `
        //     <h2>Add Card</h2>
        //     <form action="" id="inputForm">
        //     <label for="cardNameId">Card Name:</label>
        //     <input type="text" placeholder="Name" id="cardNameId" name="cardName" required>

        //     <label for="cardRulesId">Card Rules:</label>
        //     <textarea id="cardRulesId" placeholder="Description" rows="4" cols="50"></textarea>

        //     <label for="imageInput">Card Image:</label>
        //     <input type="file" id="imageInput" name="cardImage" accept="image/*" required>


        //     <label for="tagInputId">Tag:</label>
        //     <input type="text" id="tagInputId" name="tagInput">
        //     <button type="button" id="addTagButton">Add Tag</button>
        //     <p id="tagListP"></p>


        //     <button type="submit" form="inputForm">Submit</button>
        //     </form>
        // `;

        // rightColumn.innerHTML = `
            
        //     <div class="preview-right-column" id="previewRightColumn">

        //         <h2>Add Card</h2>
        //         <div id="cardInformation">
        //             <!-- Add fields for the cards to be populated here-->
        //         </div>

        //         <p id="overlayTypeTest">Type</p>



        //         <button id="">Add to Prevsdsdiew</button>


        //         <button id="option1Button" class="overlay-option">Option 1</button>
        //         <button id="option2Button" class="overlay-option">Option 2</button>
        //         <p id="overlayRulesText" class="overlay-option">Bird text goes in here</p>





        //     </div>
        // `;


        // Handle different options
        if (selectedOption === "view") {
            // Custom inputs for type 1
             leftColumn.innerHTML += `
             
            `;
        

            rightColumn.innerHTML = `
            <!--     <button id="addPreviewButton" >Add to Preview</button>      --!>
            <button id="addToDeckButton" >Add to Deck</button>
            <select id="addDeckSelectionId">
                
            </select>
            <p id="overlayCardTitleP">` + cardTitleText + `</p>
             
            `;


            // Fill the Add to Deck dropdown with user's current Decks

            const deckRef = ref_database(database, 'Users/' + auth.currentUser.uid + '/Decks');
            
            const deckDropdown = document.getElementById("addDeckSelectionId");

            // For each Deck,
            onChildAdded(deckRef, (snapshot) => {
                const value = snapshot.val();
                const key = snapshot.key;

                // get a reference of how many cards are in the deck for a counter
                const cardsRef = ref_database(database, 'Users/' + auth.currentUser.uid + '/Decks/' + key);
                let cardCounter = 0;
                onChildAdded(cardsRef, (snapshot) => {
                    cardCounter++;
                });
                cardCounter--; // account for the Deck Name in the card list

                const deckSelectOption = document.createElement("option");
                deckSelectOption.textContent = value.name + '(' + cardCounter + ')';
                deckSelectOption.setAttribute('value', key);

                deckDropdown.appendChild(deckSelectOption);

            });




            // // Here is where we want to set a listener for the preview button, after the View is selected
            // document.getElementById("addPreviewButton").addEventListener("click", function() {
            //         addCardToPreviewQueue();
            // });



             //set a listener for the deck button, after the View is selected
             document.getElementById("addToDeckButton").addEventListener("click", function() {

                    const cardToBeAdded = document.getElementById("overlayCardTitleP").textContent;
                    const currentUser = auth.currentUser.uid;


                    const currentDeckSelection = document.getElementById("addDeckSelectionId");
                    const currentDeck = currentDeckSelection.value; // Update this so the user can select which deck they want to add to





                    const dataRef = ref_database(database, 'Users/' + currentUser + '/Decks/' + currentDeck);

                    let counter = 0;
                    // For each card found in the deck, increment a counter for new card position
                    onChildAdded(dataRef, (snapshot) => {
                        
                        counter++;
                        
                    });

                    
                   
                    //console.log(counter);
                    
                    
                    // Data may not need to look like this if it's being set specifically at a location (tbd)
                    // const data = {
                    //     card: cardToBeAdded
                    // }

                    // Dataref.child should be the correct node (may need to Import the Child method)
                    // At the Deck node, Set a child node to 'Counter: cardToBeAdded' ex 5: Kerfeather
                    const cardPositionRef = ref_database(database, 'Users/' + currentUser + '/Decks/' + currentDeck + "/" + counter);
                    set (cardPositionRef, cardToBeAdded);




            });

            // Custom preview for type 1
            // rightColumn.innerHTML += `
            // <div class="type1-preview">
            //     <!-- Custom preview content for type 1 -->
            // </div>
            // `;
        } else if (selectedOption === "edit") {
            // Custom inputs for type 2
            // leftColumn.innerHTML += `
    
            // `;

            rightColumn.innerHTML = `
            <p id="overlayCardTitleP">` + cardTitleText + `</p>
            <p>Edit</p>

            
            `;

            // Custom preview for type 2
            // rightColumn.innerHTML += `
            // <div class="type2-preview">
            //     <!-- Custom preview content for type 2 -->
            // </div>
            // `;
        } else if (selectedOption === "delete") {
            // Custom inputs for type 3
            

            rightColumn.innerHTML = `
            <p id="overlayCardTitleP">` + cardTitleText + `</p>
            <p>Delete</p>
            `;

            // Custom preview for type 3
            // rightColumn.innerHTML += `
            // <div class="type3-preview">
            //     <!-- Custom preview content for type 3 -->
            // </div>
            // `;
        }


        // Set a listener for the dropdown selection
        document.getElementById("editSelect").addEventListener("change", function() {
            toggleEditCardInputs();
        });

        


    }













    // PRINT CARD BUTTON IN QUEUE SHOULD DOWNLOAD THE QUEUE OF CURRENT CARD
    document.getElementById("printCardSheetId").addEventListener("click", function(event) {
        const newImage = new Image();
        
        // returnCardSheet().then((printSheetImage) => {
        //     const testImage = document.getElementById("testingCardQueueId");
        //     testImage.src = printSheetImage;
        //     console.log(printSheetImage);
        //     const link = document.createElement('a');
        //     link.href = printSheetImage;
        //     link.download = "printedSheet.png";
        //     link.click();
        // });

    
            
    });

    // Utility to convert img to base64
    function convertImageToBase64(imageUrl) {
        return new Promise((resolve, reject) => {

            convertedUrl = convertFirebaseUrlToProxyUrl(imageUrl);
            console.log(convertedUrl);

            fetch(convertedUrl)
            .then(response => response.blob())
            .then(blob => {
                    const reader = new FileReader();
                    reader.onloadend = function () {
                    const base64data = reader.result;
                    resolve(base64data);
                };
                reader.readAsDataURL(blob);
            })
            .catch(error => {
                reject(error);
            });
        });
    }

    function convertFirebaseUrlToProxyUrl(firebaseUrl) {
        const urlObject = new URL(firebaseUrl);

        // Extract the path from the Firebase Storage URL
        const path = urlObject.pathname.substring(1);

        // URL encode the path
        //const encodedPath = encodeURIComponent(path);

        // Construct the final proxy URL
        const proxyUrl = `/proxy-storage/${path}?${urlObject.searchParams.toString()}`;

        return proxyUrl;
    }


    // JavaScript function that takes an HTML element and returns the screenshot as an image URL
    function takeAndReturnScreenshot(element) {
        return new Promise((resolve, reject) => {
            html2canvas(element).then(function (canvas) {
            try {
                // Convert the canvas to an image URL
                const imgURL = canvas.toDataURL('image/png');

                const link = document.createElement('a');
                link.href = imgURL;
                link.download = "printedSheet.png";
                link.click();

                // Return the image URL
                resolve(imgURL);
            } catch (error) {
                // If there's an error during the screenshot capture process, reject the promise
                reject(error);
            }
            });
        });
    }




    const cardQueueImageArray = [];


    function addCardToPreviewQueue() {
        // FILL AN IMAGE QUEUE WHEN YOU ADD A CARD


        const overlayPreview = document.getElementById("newImagePreview");
        const imageToBeAdded = new Image();

        takeAndReturnScreenshot(overlayPreview).then(screenshot => {

            cardQueueImageArray.push(screenshot);

            console.log(cardQueueImageArray);

            const cardPreview = document.getElementById("cardQueuePreviewId");
            cardPreview.setAttribute('src', screenshot);


        })
        .catch(error => {
            console.log("Error: screenshot");
        });

        //imageToBeAdded.src = takeAndReturnScreenshot(overlayPreview).result;
        
        
        // console.log(overlayPreview.src);
        // overlayPreview.src = convertFirebaseUrlToProxyUrl(overlayPreview.src);
        // console.log(overlayPreview.src);

        // const testImagez = document.getElementById("testingCardQueueId");
        // testImagez.src = overlayPreview.src;

        // convertImageToBase64(imageToBeAdded.src)
        //     .then(b64Data => {
        //         console.log('Base 64 image: ' + b64Data);
        //     })
        //     .catch(error => {
        //         console.error('Error, image unable to convert');
        //     });


        imageToBeAdded.onload = function() {
            
           
            
        };

    

        // const cardPreview = document.getElementById("cardQueuePreviewId");
        // cardPreview.setAttribute('src', overlayPreview.src);







    }


  // Utility to combine print queue cards together and return one print sheet
    function returnCardSheet() {
        return new Promise((resolve) => {
            // Create a new canvas element
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
          
            canvas.width = 400; // Set the desired width of the canvas
            canvas.height = 400; // Set the desired height of the canvas
            //document.body.appendChild(canvas);

            // Get the 2D rendering context of the canvas

            // Loop through the image array and draw each square image onto the canvas
            cardQueueImageArray.forEach((imagePath, index) => {
                const squareImage = new Image();
                squareImage.src = imagePath;
                console.log(squareImage);
                    const x = index * 100; // Adjust the position of each square image
                    const y = 0;
                    context.drawImage(squareImage, x, y);
                
            });



            // Save the combined image
            const combinedImage = canvas.toDataURL();
            
            resolve(combinedImage);
           
        });
    }









    </script>
    
    

    
</body>
</html>